
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Mx_Coculture: Correction &#8212; Ion suppression correction  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Mx_Coculture: Processing" href="pipeline_02_processing.html" />
    <link rel="prev" title="Mx_Coculture: Data preparation" href="dataset_prep.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="pipeline_02_processing.html" title="Mx_Coculture: Processing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="dataset_prep.html" title="Mx_Coculture: Data preparation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Ion suppression correction  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Mx_Coculture: Correction</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Mx_Coculture:-Correction">
<h1>Mx_Coculture: Correction<a class="headerlink" href="#Mx_Coculture:-Correction" title="Permalink to this heading">Â¶</a></h1>
<p>SpaceM datasets are usually stored as annotated data-matrices, separately for individual wells. With this notebooks, these individual files are corrected for ion suppression on the pixel-level and then deconvoluted to cell-level. All resulting files are saved separately by well to the target_path and the impact of the correction briefly shown for visual inspection.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">statistics</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/mklein/spacem&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/mklein/FDA_project&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">src.correction</span> <span class="kn">import</span> <span class="p">(</span><span class="n">add_normalization_factors</span><span class="p">,</span>
                            <span class="n">correct_quantile_inplace</span><span class="p">,</span>
                            <span class="n">deconvolution_spacem</span><span class="p">,</span>
                            <span class="n">get_overlap_data</span><span class="p">,</span>
                            <span class="n">add_overlap_matrix_spacem</span>
                           <span class="p">)</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">SpaceM.lib.modules</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">overlap_analysis</span><span class="p">,</span>
    <span class="n">single_cell_analysis_normalization</span>
<span class="p">)</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<p>The original data lies on the groups shared data storage. Corrected files will be saved in a separate location, preserving the well-specific folder structure.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
    <span class="n">source_path</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/alexandr/smenon/2022-07-13_Glioblastoma/processed_files&#39;</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/mklein/FDA_project/data/Lx_Glioblastoma&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">source_path</span> <span class="o">=</span> <span class="s1">&#39;/g/alexandr/smenon/2022-07-13_Glioblastoma/processed_files&#39;</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="s1">&#39;/home/mklein/FDA_project/data/Lx_Glioblastoma&#39;</span>

<span class="c1"># TODO: implement topX reference ion pool.</span>
<span class="n">reference_pool</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<span class="n">deconv_default_min_overlap</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters</span>
<span class="n">source_path</span> <span class="o">=</span> <span class="s2">&quot;/home/mklein/Raw Data/Coculture&quot;</span>
<span class="n">target_path</span> <span class="o">=</span> <span class="s2">&quot;/home/mklein/FDA_project/data/Mx_Co_Cultured&quot;</span>
<span class="n">condition_name</span> <span class="o">=</span> <span class="s2">&quot;condition&quot;</span>
<span class="n">well_name</span> <span class="o">=</span> <span class="s2">&quot;rowcol&quot;</span>
<span class="n">deconv_default_min_overlap</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">analysis_path</span> <span class="o">=</span> <span class="s2">&quot;/home/mklein/FDA_project/analysis/Mx_Coculture&quot;</span>
<span class="n">notebooks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;pipeline_01_correction.ipynb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pipeline_02_processing.ipynb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pipeline_03_evaluation.ipynb&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">project</span> <span class="o">=</span> <span class="s2">&quot;Mx_Coculture&quot;</span>
<span class="n">correction_proportion_threshold</span> <span class="o">=</span> <span class="mf">0.1</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;analysis&#39;</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">source_path</span><span class="o">+</span><span class="s1">&#39;/?&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">))</span>
<span class="n">samples</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;dataset&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="s1">&#39;../config.json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sm_matrix&#39;</span><span class="p">:</span> <span class="s1">&#39;ablation_mark_analysis/spatiomolecular_adata.h5ad&#39;</span><span class="p">,</span>
        <span class="s1">&#39;overlap_regions&#39;</span><span class="p">:</span> <span class="s1">&#39;overlap_analysis2/overlap.regions.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mark_regions&#39;</span><span class="p">:</span> <span class="s1">&#39;overlap_analysis2/ablation_mark.regions.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cell_regions&#39;</span><span class="p">:</span> <span class="s1">&#39;overlap_analysis2/cell.regions.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cell_sm_matrix&#39;</span><span class="p">:</span> <span class="s1">&#39;single_cell_analysis/spatiomolecular_adata.h5ad&#39;</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assign_average_tpo</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">overlap_data</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">min_overlap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_overlap</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap_data</span><span class="o">.</span><span class="n">overlap_regions</span>
    <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;am_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;am_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">overlap</span><span class="p">[[</span><span class="s1">&#39;am_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">]],</span> <span class="n">am_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;am_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_overlap</span><span class="p">]</span>

    <span class="n">mean_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;correction_total_pixel_overlap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
<span class="c1">#     mean_df = merged_df[[&#39;cell_id&#39;, &#39;correction_total_pixel_overlap&#39;]].groupby(&#39;cell_id&#39;, group_keys=False).agg(lambda x: method(x))</span>
    <span class="k">return</span> <span class="n">mean_df</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">correct_sample_spacem</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>

    <span class="n">sample_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">))</span>

    <span class="c1"># get appropriate file paths for the processed well</span>
    <span class="n">project_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">deconv_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;single_cell_analysis&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">deconv_info</span><span class="p">[</span><span class="s1">&#39;ablation_marks_min_overlap_ratio&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deconv_info</span><span class="p">[</span><span class="s1">&#39;ablation_marks_min_overlap_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deconv_default_min_overlap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deconv_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cell_normalization_method&#39;</span><span class="p">:</span> <span class="s1">&#39;weighted_by_overlap_and_sampling_area&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;ablation_marks_min_overlap_ratio&#39;</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No well config file found. Using default deconvolution parameters.&#39;</span><span class="p">)</span>
    <span class="c1"># load required files</span>
    <span class="n">cell_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;cell_regions&#39;</span><span class="p">])</span>
    <span class="n">mark_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;mark_regions&#39;</span><span class="p">])</span>
    <span class="n">overlap_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;overlap_regions&#39;</span><span class="p">])</span>

    <span class="n">sm_matrix</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;sm_matrix&#39;</span><span class="p">]))</span>
    <span class="n">cell_sm_matrix</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;cell_sm_matrix&#39;</span><span class="p">]))</span>


    <span class="n">add_overlap_matrix_spacem</span><span class="p">(</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">cell_regions</span><span class="p">,</span> <span class="n">mark_regions</span><span class="p">,</span> <span class="n">overlap_regions</span><span class="p">)</span>
    <span class="n">add_normalization_factors</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

    <span class="c1"># perform the actual quantile regression</span>
    <span class="n">corr_sm_matrix</span> <span class="o">=</span> <span class="n">correct_quantile_inplace</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">sm_matrix</span><span class="p">,</span>
        <span class="n">reference_ions</span><span class="o">=</span><span class="n">sm_matrix</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span>
        <span class="n">correct_intersect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">proportion_threshold</span> <span class="o">=</span> <span class="n">correction_proportion_threshold</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># perform pixel-cell-deconvolution</span>
    <span class="n">overlap_data</span> <span class="o">=</span> <span class="n">get_overlap_data</span><span class="p">(</span><span class="n">cell_regions</span><span class="p">,</span> <span class="n">mark_regions</span><span class="p">,</span> <span class="n">overlap_regions</span><span class="p">)</span>
    <span class="c1"># corr_cell_sm_matrix = deconvolution_spacem(adata=corr_sm_matrix,</span>
    <span class="c1">#     overlap_data=overlap_data,</span>
    <span class="c1">#     raw_adata=cell_sm_matrix,</span>
    <span class="c1">#     deconvolution_params=deconv_info)</span>
    <span class="c1"># gen_cell_sm_matrix = deconvolution_spacem(adata=sm_matrix,</span>
    <span class="c1">#     overlap_data=overlap_data,</span>
    <span class="c1">#     raw_adata=cell_sm_matrix,</span>
    <span class="c1">#     deconvolution_params=deconv_info)</span>

    <span class="kn">from</span> <span class="nn">src.correction</span> <span class="kn">import</span> <span class="n">deconvolution_rappez</span><span class="p">,</span> <span class="n">get_matrices_from_dfs</span><span class="p">,</span> <span class="n">add_matrices</span>
    <span class="n">overlap_matrix</span><span class="p">,</span> <span class="n">sampling_spec_matrix</span> <span class="o">=</span> <span class="n">get_matrices_from_dfs</span><span class="p">(</span><span class="n">mark_area</span><span class="o">=</span><span class="n">mark_regions</span><span class="p">,</span> <span class="n">cell_area</span><span class="o">=</span><span class="n">cell_regions</span><span class="p">,</span> <span class="n">marks_cell_overlap</span><span class="o">=</span><span class="n">overlap_regions</span><span class="p">)</span>
    <span class="n">add_matrices</span><span class="p">(</span><span class="n">adata</span> <span class="o">=</span> <span class="n">sm_matrix</span><span class="p">,</span> <span class="n">overlap_matrix</span> <span class="o">=</span> <span class="n">overlap_matrix</span><span class="p">,</span> <span class="n">sampling_spec_matrix</span> <span class="o">=</span> <span class="n">sampling_spec_matrix</span><span class="p">)</span>
    <span class="n">add_matrices</span><span class="p">(</span><span class="n">adata</span> <span class="o">=</span> <span class="n">corr_sm_matrix</span><span class="p">,</span> <span class="n">overlap_matrix</span> <span class="o">=</span> <span class="n">overlap_matrix</span><span class="p">,</span> <span class="n">sampling_spec_matrix</span> <span class="o">=</span> <span class="n">sampling_spec_matrix</span><span class="p">)</span>

    <span class="n">gen_cell_sm_matrix</span> <span class="o">=</span> <span class="n">deconvolution_rappez</span><span class="p">(</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">raw_adata</span><span class="o">=</span><span class="n">cell_sm_matrix</span><span class="p">)</span>
    <span class="n">corr_cell_sm_matrix</span> <span class="o">=</span> <span class="n">deconvolution_rappez</span><span class="p">(</span><span class="n">corr_sm_matrix</span><span class="p">,</span> <span class="n">raw_adata</span><span class="o">=</span><span class="n">cell_sm_matrix</span><span class="p">)</span>

    <span class="c1"># hand over TPOs to spatiomolecular matrix for downstream analysis</span>
    <span class="n">min_overlap</span> <span class="o">=</span> <span class="n">deconv_info</span><span class="p">[</span><span class="s1">&#39;ablation_marks_min_overlap_ratio&#39;</span><span class="p">]</span>
    <span class="n">corr_cell_sm_matrix</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;list_TPO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_average_tpo</span><span class="p">(</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">overlap_data</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>
    <span class="n">gen_cell_sm_matrix</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;list_TPO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_average_tpo</span><span class="p">(</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">overlap_data</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>

    <span class="c1"># write the generated files to the dedicated project location.</span>
    <span class="n">corr_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;am_spatiomolecular_adata_corrected.h5ad&#39;</span><span class="p">))</span>
    <span class="n">sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;am_spatiomolecular_adata.h5ad&#39;</span><span class="p">))</span>
    <span class="n">corr_cell_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;cells_spatiomolecular_adata_corrected.h5ad&#39;</span><span class="p">))</span>
    <span class="n">cell_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;cells_spatiomolecular_adata_spacem.h5ad&#39;</span><span class="p">))</span>
    <span class="n">gen_cell_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;cells_spatiomolecular_adata.h5ad&#39;</span><span class="p">))</span>
    <span class="c1">#               deconv using own implementation                                                  deconv by Martijn</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">gen_cell_sm_matrix</span><span class="p">,</span> <span class="n">corr_cell_sm_matrix</span><span class="p">,</span> <span class="n">sm_matrix</span><span class="p">,</span> <span class="n">corr_sm_matrix</span><span class="p">,</span> <span class="n">deconv_info</span><span class="p">,</span> <span class="n">cell_sm_matrix</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This is the actual correction pipeline.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># adata_list = Parallel(n_jobs=7)(delayed(correct_sample_spacem)(sample) for sample in tqdm(samples))</span>
<span class="n">adata_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">correct_sample_spacem</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">([</span><span class="s1">&#39;dataset&#39;</span><span class="p">])]</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
  0%|          | 0/1 [00:00&lt;?, ?it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
No well config file found. Using default deconvolution parameters.
Using 115 pixels to calculate full-pixel avereage intensities.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/mklein/.conda/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.
  warnings.warn(&#34;Maximum number of iterations (&#34; + str(max_iter) +
100%|ââââââââââ| 1/1 [00:16&lt;00:00, 16.06s/it]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reshape data for immediate analysis</span>
<span class="n">gen_adata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">adata_cor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">am_adata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">am_adata_cor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">adata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>

<span class="n">am_adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">am_adata_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">am_adata_cor</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">am_adata_cor_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
<span class="n">gen_adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">gen_adata_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">adata_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">adata_cor</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">adata_cor_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>

<span class="n">deconv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">deconv_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">deconv_dict</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">deconv_table</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ablation_marks_min_overlap_ratio</th>
      <th>cell_normalization_method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>dataset</th>
      <td>0</td>
      <td>weighted_by_overlap_and_sampling_area</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>The ion suppression correction takes a parameter proportion_threshold to filter the pixels used to compute quantile regression. In particular, pixels with a sampling proportion lower than the threshold are excluded for this step. In contrast, the actual correction is then performed on all pixels in the dataset. As a consequence, for the majority of the dataset, the dependence of the data on the factor âsampling_proportionâ is not completely removed by the correction. Instead, depending on the
difference in slope between the complete and thresholded set of pixels, the corrected set of pixels has a positive or negative dependence on the factor âsampling_proportionâ. The larger the proportion_threshold, the stronger this deviation can get.</p>
<p>In the following figure, these differences are visualized for a subset of ions (with very low/high correction slope) and wells. The top panel shows the logarithmic ion intensity/proportion ratio plotted against the log proportion ratio of the respective pixels. As this is the relationship used to compute the quantile regression, the resulting regression lines can also be shown. The black lines show the quantile regression of the total set of pixels in a well, the red lines for the thresholded
set (shown as orange squares). In turn, the blue squares are disregarded in calculating the correction slope. The bottom panel shows the corresponding corrected sets of pixels with black lines again representing the quantile regression on the complete set of pixels.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">am_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span> <span class="o">=</span> <span class="n">am_adata_cor</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">src.evaluation</span> <span class="kn">import</span> <span class="n">compare_pre_post_correction</span>
<span class="n">compare_pre_post_correction</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">am_adata_cor</span><span class="p">,</span> <span class="n">proportion_threshold</span><span class="o">=</span><span class="n">correction_proportion_threshold</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>intercept_correction</th>
      <th>intercept_glob_ISM_correction</th>
      <th>intercept_glob_uncorrected</th>
      <th>slope_correction</th>
      <th>slope_glob_ISM_correction</th>
      <th>slope_glob_uncorrected</th>
    </tr>
    <tr>
      <th>ion</th>
      <th>well</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>C35H69O8P</th>
      <th>dataset</th>
      <td>0.005922</td>
      <td>0.023198</td>
      <td>0.023198</td>
      <td>-1.077399</td>
      <td>0.073245</td>
      <td>-1.004155</td>
    </tr>
    <tr>
      <th>C34H68NO6P</th>
      <th>dataset</th>
      <td>0.023201</td>
      <td>0.034094</td>
      <td>0.034094</td>
      <td>-1.031471</td>
      <td>0.052090</td>
      <td>-0.979381</td>
    </tr>
    <tr>
      <th>C43H78NO8P</th>
      <th>dataset</th>
      <td>-0.066371</td>
      <td>-0.092249</td>
      <td>-0.092249</td>
      <td>0.029649</td>
      <td>-0.215767</td>
      <td>-0.186117</td>
    </tr>
    <tr>
      <th>C20H32O2</th>
      <th>dataset</th>
      <td>-0.080099</td>
      <td>-0.151280</td>
      <td>-0.151279</td>
      <td>0.060849</td>
      <td>-0.472976</td>
      <td>-0.412127</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/analysis_Mx_Coculture_pipeline_01_correction_15_1.png" src="../../_images/analysis_Mx_Coculture_pipeline_01_correction_15_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/analysis_Mx_Coculture_pipeline_01_correction_15_2.png" src="../../_images/analysis_Mx_Coculture_pipeline_01_correction_15_2.png" />
</div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="dataset_prep.html"
                          title="previous chapter">Mx_Coculture: Data preparation</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="pipeline_02_processing.html"
                          title="next chapter">Mx_Coculture: Processing</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/analysis/Mx_Coculture/pipeline_01_correction.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="pipeline_02_processing.html" title="Mx_Coculture: Processing"
             >next</a> |</li>
        <li class="right" >
          <a href="dataset_prep.html" title="Mx_Coculture: Data preparation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Ion suppression correction  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Mx_Coculture: Correction</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Marius Klein.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>