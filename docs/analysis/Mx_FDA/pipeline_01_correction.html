
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>High-throughput ion suppression correction &#8212; Ion suppression correction  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Ion suppression correction  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">High-throughput ion suppression correction</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="High-throughput-ion-suppression-correction">
<h1>High-throughput ion suppression correction<a class="headerlink" href="#High-throughput-ion-suppression-correction" title="Permalink to this heading">¶</a></h1>
<p>SpaceM datasets are usually stored as annotated data-matrices, separately for individual wells. With this notebooks, these individual files are corrected for ion suppression on the pixel-level and then deconvoluted to cell-level. All resulting files are saved separately by well to the target_path and the impact of the correction briefly shown for visual inspection.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">statistics</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/mklein/spacem&#39;</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;/home/mklein/FDA_project&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">src.correction</span> <span class="kn">import</span> <span class="p">(</span><span class="n">add_normalization_factors</span><span class="p">,</span>
                            <span class="n">correct_quantile_inplace</span><span class="p">,</span>
                            <span class="n">deconvolution_spacem</span><span class="p">,</span>
                            <span class="n">get_overlap_data</span><span class="p">,</span>
                            <span class="n">add_overlap_matrix_spacem</span>
                           <span class="p">)</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">SpaceM.lib.modules</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">overlap_analysis</span><span class="p">,</span>
    <span class="n">single_cell_analysis_normalization</span>
<span class="p">)</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">config</span> InlineBackend.figure_formats = [&#39;retina&#39;]
</pre></div>
</div>
</div>
<p>The original data lies on the groups shared data storage. Corrected files will be saved in a separate location, preserving the well-specific folder structure.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
    <span class="n">source_path</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/alexandr/smenon/2022-07-13_Glioblastoma/processed_files&#39;</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/mklein/FDA_project/data/Lx_Glioblastoma&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">source_path</span> <span class="o">=</span> <span class="s1">&#39;/g/alexandr/smenon/2022-07-13_Glioblastoma/processed_files&#39;</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="s1">&#39;/home/mklein/FDA_project/data/Lx_Glioblastoma&#39;</span>

<span class="c1"># TODO: implement topX reference ion pool.</span>
<span class="n">reference_pool</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;top&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
<span class="n">deconv_default_min_overlap</span> <span class="o">=</span> <span class="mf">0.0</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters</span>
<span class="n">source_path</span> <span class="o">=</span> <span class="s2">&quot;/home/mklein/Raw Data/2022-02-18_FDA_SpaceM&quot;</span>
<span class="n">target_path</span> <span class="o">=</span> <span class="s2">&quot;/home/mklein/FDA_project/data/Mx_FDA&quot;</span>
<span class="n">condition_name</span> <span class="o">=</span> <span class="s2">&quot;celltype&quot;</span>
<span class="n">well_name</span> <span class="o">=</span> <span class="s2">&quot;rowcol&quot;</span>
<span class="n">analysis_path</span> <span class="o">=</span> <span class="s2">&quot;/home/mklein/FDA_project/analysis/Mx_FDA&quot;</span>
<span class="n">notebooks</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;pipeline_01_correction.ipynb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pipeline_02_processing.ipynb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pipeline_03_evaluation.ipynb&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">project</span> <span class="o">=</span> <span class="s2">&quot;Mx_FDA&quot;</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">source_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;analysis&#39;</span> <span class="ow">in</span> <span class="n">dirnames</span><span class="p">:</span>
            <span class="n">samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">source_path</span><span class="o">+</span><span class="s1">&#39;/?&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">dirpath</span><span class="p">))</span>
<span class="n">samples</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;w4&#39;, &#39;w2&#39;, &#39;w3&#39;, &#39;w5&#39;, &#39;w6&#39;, &#39;w7&#39;, &#39;w8&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="s1">&#39;../config.json&#39;</span><span class="p">,</span>
        <span class="s1">&#39;sm_matrix&#39;</span><span class="p">:</span> <span class="s1">&#39;ablation_mark_analysis/spatiomolecular_adata.h5ad&#39;</span><span class="p">,</span>
        <span class="s1">&#39;overlap_regions&#39;</span><span class="p">:</span> <span class="s1">&#39;overlap_analysis2/overlap.regions.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mark_regions&#39;</span><span class="p">:</span> <span class="s1">&#39;overlap_analysis2/ablation_mark.regions.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cell_regions&#39;</span><span class="p">:</span> <span class="s1">&#39;overlap_analysis2/cell.regions.csv&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cell_sm_matrix&#39;</span><span class="p">:</span> <span class="s1">&#39;single_cell_analysis/spatiomolecular_adata.h5ad&#39;</span><span class="p">,</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">assign_average_tpo</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">overlap_data</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">min_overlap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_overlap</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">overlap</span> <span class="o">=</span> <span class="n">overlap_data</span><span class="o">.</span><span class="n">overlap_regions</span>
    <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;am_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;am_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">overlap</span><span class="p">[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">overlap</span><span class="p">[[</span><span class="s1">&#39;am_id&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_id&#39;</span><span class="p">]],</span> <span class="n">am_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">],</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;am_id&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[</span><span class="n">merged_df</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_overlap</span><span class="p">]</span>

    <span class="n">mean_df</span> <span class="o">=</span> <span class="n">merged_df</span><span class="p">[[</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="s1">&#39;correction_total_pixel_overlap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;cell_id&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
<span class="c1">#     mean_df = merged_df[[&#39;cell_id&#39;, &#39;correction_total_pixel_overlap&#39;]].groupby(&#39;cell_id&#39;, group_keys=False).agg(lambda x: method(x))</span>
    <span class="k">return</span> <span class="n">mean_df</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">correct_sample_spacem</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>

    <span class="n">sample_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s2">&quot;analysis&quot;</span><span class="p">)</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">))</span>

    <span class="c1"># get appropriate file paths for the processed well</span>
    <span class="n">project_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">])</span> <span class="k">as</span> <span class="n">json_file</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_file</span><span class="p">)</span>
        <span class="n">deconv_info</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;single_cell_analysis&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">deconv_info</span><span class="p">[</span><span class="s1">&#39;ablation_marks_min_overlap_ratio&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deconv_info</span><span class="p">[</span><span class="s1">&#39;ablation_marks_min_overlap_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">deconv_default_min_overlap</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deconv_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No well config file found. Using default deconvolution parameters.&#39;</span><span class="p">)</span>
    <span class="c1"># load required files</span>
    <span class="n">cell_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;cell_regions&#39;</span><span class="p">])</span>
    <span class="n">mark_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;mark_regions&#39;</span><span class="p">])</span>
    <span class="n">overlap_regions</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">project_files</span><span class="p">[</span><span class="s1">&#39;overlap_regions&#39;</span><span class="p">])</span>

    <span class="n">sm_matrix</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;sm_matrix&#39;</span><span class="p">]))</span>
    <span class="n">cell_sm_matrix</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sample_path</span><span class="p">,</span> <span class="n">files</span><span class="p">[</span><span class="s1">&#39;cell_sm_matrix&#39;</span><span class="p">]))</span>

    <span class="n">add_overlap_matrix_spacem</span><span class="p">(</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">cell_regions</span><span class="p">,</span> <span class="n">mark_regions</span><span class="p">,</span> <span class="n">overlap_regions</span><span class="p">)</span>

    <span class="n">add_normalization_factors</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">st</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

    <span class="c1"># perform the actual quantile regression</span>
    <span class="n">corr_sm_matrix</span> <span class="o">=</span> <span class="n">correct_quantile_inplace</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">sm_matrix</span><span class="p">,</span>
        <span class="n">reference_ions</span><span class="o">=</span><span class="n">sm_matrix</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span>
        <span class="n">correct_intersect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="c1"># perform pixel-cell-deconvolution</span>
    <span class="n">overlap_data</span> <span class="o">=</span> <span class="n">get_overlap_data</span><span class="p">(</span><span class="n">cell_regions</span><span class="p">,</span> <span class="n">mark_regions</span><span class="p">,</span> <span class="n">overlap_regions</span><span class="p">)</span>
    <span class="n">corr_cell_sm_matrix</span> <span class="o">=</span> <span class="n">deconvolution_spacem</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">corr_sm_matrix</span><span class="p">,</span>
        <span class="n">overlap_data</span><span class="o">=</span><span class="n">overlap_data</span><span class="p">,</span>
        <span class="n">raw_adata</span><span class="o">=</span><span class="n">cell_sm_matrix</span><span class="p">,</span>
        <span class="n">deconvolution_params</span><span class="o">=</span><span class="n">deconv_info</span><span class="p">)</span>
    <span class="n">gen_cell_sm_matrix</span> <span class="o">=</span> <span class="n">deconvolution_spacem</span><span class="p">(</span><span class="n">adata</span><span class="o">=</span><span class="n">sm_matrix</span><span class="p">,</span>
        <span class="n">overlap_data</span><span class="o">=</span><span class="n">overlap_data</span><span class="p">,</span>
        <span class="n">raw_adata</span><span class="o">=</span><span class="n">cell_sm_matrix</span><span class="p">,</span>
        <span class="n">deconvolution_params</span><span class="o">=</span><span class="n">deconv_info</span><span class="p">)</span>

    <span class="c1"># hand over TPOs to spatiomolecular matrix for downstream analysis</span>
    <span class="n">min_overlap</span> <span class="o">=</span> <span class="n">deconv_info</span><span class="p">[</span><span class="s1">&#39;ablation_marks_min_overlap_ratio&#39;</span><span class="p">]</span>
    <span class="n">corr_cell_sm_matrix</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;list_TPO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_average_tpo</span><span class="p">(</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">overlap_data</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>
    <span class="n">gen_cell_sm_matrix</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;list_TPO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign_average_tpo</span><span class="p">(</span><span class="n">sm_matrix</span><span class="p">,</span> <span class="n">overlap_data</span><span class="p">,</span> <span class="n">min_overlap</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>

    <span class="c1"># write the generated files to the dedicated project location.</span>
    <span class="n">corr_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;am_spatiomolecular_adata_corrected.h5ad&#39;</span><span class="p">))</span>
    <span class="n">sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;am_spatiomolecular_adata.h5ad&#39;</span><span class="p">))</span>
    <span class="n">corr_cell_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;cells_spatiomolecular_adata_corrected.h5ad&#39;</span><span class="p">))</span>
    <span class="n">cell_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;cells_spatiomolecular_adata_spacem.h5ad&#39;</span><span class="p">))</span>
    <span class="n">gen_cell_sm_matrix</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="n">sample</span><span class="p">,</span> <span class="s1">&#39;cells_spatiomolecular_adata.h5ad&#39;</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">cell_sm_matrix</span><span class="p">,</span> <span class="n">corr_cell_sm_matrix</span><span class="p">,</span> <span class="n">sm_matrix</span><span class="p">,</span> <span class="n">corr_sm_matrix</span><span class="p">,</span> <span class="n">deconv_info</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This is the actual correction pipeline.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_list</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">7</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">correct_sample_spacem</span><span class="p">)(</span><span class="n">sample</span><span class="p">)</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">samples</span><span class="p">))</span>
<span class="c1"># adata_list = [correct_sample_spacem(sample) for sample in tqdm([&#39;I4&#39;])]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 7/7 [00:00&lt;00:00, 65.33it/s]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># reshape data for immediate analysis</span>
<span class="n">am_adata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">am_adata_cor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">adata_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">adata_cor_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>

<span class="n">am_adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">am_adata_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">am_adata_cor</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">am_adata_cor_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">adata_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>
<span class="n">adata_cor</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">adata_cor_dict</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">index_unique</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;first&quot;</span><span class="p">)</span>

<span class="n">deconv_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">item</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">adata_list</span><span class="p">}</span>
<span class="n">deconv_table</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">deconv_dict</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
<span class="n">deconv_table</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cell_normalization_method</th>
      <th>ablation_marks_min_overlap_ratio</th>
      <th>fluorescence_channels</th>
      <th>cell_ion_max_correlation_distance</th>
      <th>ions_of_interest</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>w4</th>
      <td>biggest_overlap_raw</td>
      <td>0.3</td>
      <td>[DAPI, FITC]</td>
      <td>None</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>w2</th>
      <td>biggest_overlap_raw</td>
      <td>0.3</td>
      <td>[DAPI, FITC]</td>
      <td>None</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>w3</th>
      <td>biggest_overlap_raw</td>
      <td>0.3</td>
      <td>[FITC, DAPI]</td>
      <td>None</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>w5</th>
      <td>biggest_overlap_raw</td>
      <td>0.3</td>
      <td>[DAPI, FITC]</td>
      <td>None</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>w6</th>
      <td>biggest_overlap_raw</td>
      <td>0.3</td>
      <td>[FITC, DAPI]</td>
      <td>None</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>w7</th>
      <td>biggest_overlap_raw</td>
      <td>0.3</td>
      <td>[DAPI, FITC]</td>
      <td>None</td>
      <td>[]</td>
    </tr>
    <tr>
      <th>w8</th>
      <td>biggest_overlap_raw</td>
      <td>0.3</td>
      <td>[DAPI, FITC]</td>
      <td>None</td>
      <td>[]</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
<p>Every analysed pixel is characterized by its total overlap with cellular regions. The raw data shows no clear association between this overlap and acquired ion intensities. However, after the ion suppression correction, pixels with smaller overlap clearly have lower corresponding intensities (only shown for one metabolite).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">src.correction</span> <span class="kn">import</span> <span class="n">normalize_proportion_ratios</span>


<span class="k">def</span> <span class="nf">plot_all_wells</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">ions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="s1">&#39;well&#39;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">top_wells</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">row</span><span class="p">]))[:</span><span class="mi">5</span><span class="p">]</span>
    <span class="n">adata</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">row</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">top_wells</span><span class="p">)]</span>

    <span class="k">if</span> <span class="n">ions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ratio</span><span class="p">:</span>
        <span class="n">ions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">ions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ratio</span><span class="p">:</span>
        <span class="n">ions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">normalize_proportion_ratios</span><span class="p">(</span><span class="n">intensities_ad</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">yscale</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span>
    <span class="k">if</span> <span class="n">ratio</span><span class="p">:</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">normalize_proportion_ratios</span><span class="p">(</span><span class="n">intensities_ad</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span>
        <span class="n">yscale</span> <span class="o">=</span> <span class="s1">&#39;intensity_proportion_ratio&#39;</span>

    <span class="n">plot_df</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">obs_df</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="n">ions</span><span class="p">)</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">x</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="n">yscale</span><span class="p">)</span>
    <span class="n">plot_df</span><span class="o">=</span> <span class="n">plot_df</span><span class="p">[</span><span class="n">plot_df</span><span class="p">[</span><span class="n">yscale</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">ratio</span><span class="p">:</span>
        <span class="n">plot_df</span><span class="p">[</span><span class="n">yscale</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="n">yscale</span><span class="p">])</span>
        <span class="n">plot_df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>

    <span class="n">graph</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">margin_titles</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">graph</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">yscale</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;proportion&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">add_legend</span><span class="p">()</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">well</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="n">row</span><span class="p">])):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ions</span><span class="p">:</span>
            <span class="n">q_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="p">[(</span><span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;ion&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="n">row</span><span class="p">]</span> <span class="o">==</span> <span class="n">well</span><span class="p">)]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">q_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Intercept&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
                <span class="k">continue</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">quantreg</span><span class="p">(</span><span class="n">yscale</span><span class="o">+</span><span class="s1">&#39; ~ &#39;</span><span class="o">+</span><span class="n">x</span><span class="p">,</span> <span class="n">q_df</span><span class="p">)</span>
            <span class="n">qrmodel</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;ion&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">:</span> <span class="n">well</span><span class="p">,</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">:</span> <span class="n">qrmodel</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">:</span> <span class="n">qrmodel</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]})</span>


    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">])</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;ion&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">compare_pre_post_correction</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">adata_cor</span><span class="p">,</span> <span class="n">ions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ratio</span><span class="p">:</span>
        <span class="n">ions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">[:</span><span class="mi">5</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">ions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ratio</span><span class="p">:</span>
        <span class="n">ions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">normalize_proportion_ratios</span><span class="p">(</span><span class="n">intensities_ad</span><span class="o">=</span><span class="n">adata</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">()</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="n">df1</span> <span class="o">=</span> <span class="n">plot_all_wells</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">ions</span><span class="o">=</span><span class="n">ions</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span><span class="p">)</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">plot_all_wells</span><span class="p">(</span><span class="n">adata_cor</span><span class="p">,</span> <span class="n">ions</span><span class="o">=</span><span class="n">ions</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="n">ratio</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_uncorrected&#39;</span><span class="p">,</span> <span class="s1">&#39;_ISM_correction&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">am_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span> <span class="o">=</span> <span class="n">am_adata_cor</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">compare_pre_post_correction</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">am_adata_cor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
Cell <span class="ansi-green-fg">In [12], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">compare_pre_post_correction</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">am_adata</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">am_adata_cor</span><span class="ansi-yellow-bg">)</span>

Cell <span class="ansi-green-fg">In [10], line 52</span>, in <span class="ansi-cyan-fg">compare_pre_post_correction</span><span class="ansi-blue-fg">(adata, adata_cor, ions, ratio)</span>
<span class="ansi-green-intense-fg ansi-bold">     49</span> <span class="ansi-bold" style="color: rgb(0,135,0)">elif</span> ions <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span> <span class="ansi-bold" style="color: rgb(175,0,255)">and</span> ratio:
<span class="ansi-green-intense-fg ansi-bold">     50</span>     ions <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">list</span>(normalize_proportion_ratios(intensities_ad<span style="color: rgb(98,98,98)">=</span>adata)<span style="color: rgb(98,98,98)">.</span>to_df()<span style="color: rgb(98,98,98)">.</span>sum()<span style="color: rgb(98,98,98)">.</span>sort_values()<span style="color: rgb(98,98,98)">.</span>tail()<span style="color: rgb(98,98,98)">.</span>index)
<span class="ansi-green-fg">---&gt; 52</span> df1 <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">plot_all_wells</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">adata</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ions</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">ions</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ratio</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">ratio</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     53</span> df2 <span style="color: rgb(98,98,98)">=</span> plot_all_wells(adata_cor, ions<span style="color: rgb(98,98,98)">=</span>ions, ratio<span style="color: rgb(98,98,98)">=</span>ratio)
<span class="ansi-green-intense-fg ansi-bold">     54</span> <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> pd<span style="color: rgb(98,98,98)">.</span>merge(df1, df2, right_index<span style="color: rgb(98,98,98)">=</span><span class="ansi-bold" style="color: rgb(0,135,0)">True</span>, left_index<span style="color: rgb(98,98,98)">=</span><span class="ansi-bold" style="color: rgb(0,135,0)">True</span>, suffixes<span style="color: rgb(98,98,98)">=</span>(<span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">_uncorrected</span><span style="color: rgb(175,0,0)">&#39;</span>, <span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">_ISM_correction</span><span style="color: rgb(175,0,0)">&#39;</span>))

Cell <span class="ansi-green-fg">In [10], line 28</span>, in <span class="ansi-cyan-fg">plot_all_wells</span><span class="ansi-blue-fg">(adata, ions, row, x, ratio)</span>
<span class="ansi-green-intense-fg ansi-bold">     25</span>     plot_df[yscale] <span style="color: rgb(98,98,98)">=</span> np<span style="color: rgb(98,98,98)">.</span>log10(plot_df[yscale])
<span class="ansi-green-intense-fg ansi-bold">     26</span>     plot_df[x] <span style="color: rgb(98,98,98)">=</span> np<span style="color: rgb(98,98,98)">.</span>log10(plot_df[x])
<span class="ansi-green-fg">---&gt; 28</span> graph <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">sns</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">FacetGrid</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">plot_df</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">row</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">row</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">col</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#39;</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">ion</span><span class="ansi-yellow-bg" style="color: rgb(175,0,0)">&#39;</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">sharey</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg ansi-bold" style="color: rgb(0,135,0)">False</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">margin_titles</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg ansi-bold" style="color: rgb(0,135,0)">True</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     29</span> graph<span style="color: rgb(98,98,98)">.</span>map(sns<span style="color: rgb(98,98,98)">.</span>histplot, x, yscale, bins<span style="color: rgb(98,98,98)">=</span><span style="color: rgb(98,98,98)">50</span>, stat<span style="color: rgb(98,98,98)">=</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">proportion</span><span style="color: rgb(175,0,0)">&#39;</span>)<span style="color: rgb(98,98,98)">.</span>add_legend()
<span class="ansi-green-intense-fg ansi-bold">     31</span> params <span style="color: rgb(98,98,98)">=</span> []

File <span class="ansi-green-fg">~/.conda/envs/ion_suppression/lib/python3.10/site-packages/seaborn/axisgrid.py:456</span>, in <span class="ansi-cyan-fg">FacetGrid.__init__</span><span class="ansi-blue-fg">(self, data, row, col, hue, col_wrap, sharex, sharey, height, aspect, palette, row_order, col_order, hue_order, hue_kws, dropna, legend_out, despine, margin_titles, xlim, ylim, subplot_kws, gridspec_kws)</span>
<span class="ansi-green-intense-fg ansi-bold">    449</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> col_wrap <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span>:
<span class="ansi-green-intense-fg ansi-bold">    451</span>     kwargs <span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(0,135,0)">dict</span>(squeeze<span style="color: rgb(98,98,98)">=</span><span class="ansi-bold" style="color: rgb(0,135,0)">False</span>,
<span class="ansi-green-intense-fg ansi-bold">    452</span>                   sharex<span style="color: rgb(98,98,98)">=</span>sharex, sharey<span style="color: rgb(98,98,98)">=</span>sharey,
<span class="ansi-green-intense-fg ansi-bold">    453</span>                   subplot_kw<span style="color: rgb(98,98,98)">=</span>subplot_kws,
<span class="ansi-green-intense-fg ansi-bold">    454</span>                   gridspec_kw<span style="color: rgb(98,98,98)">=</span>gridspec_kws)
<span class="ansi-green-fg">--&gt; 456</span>     axes <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fig</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">subplots</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">nrow</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ncol</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">*</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    458</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> col <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span> <span class="ansi-bold" style="color: rgb(175,0,255)">and</span> row <span class="ansi-bold" style="color: rgb(175,0,255)">is</span> <span class="ansi-bold" style="color: rgb(0,135,0)">None</span>:
<span class="ansi-green-intense-fg ansi-bold">    459</span>         axes_dict <span style="color: rgb(98,98,98)">=</span> {}

File <span class="ansi-green-fg">~/.conda/envs/ion_suppression/lib/python3.10/site-packages/matplotlib/figure.py:894</span>, in <span class="ansi-cyan-fg">FigureBase.subplots</span><span class="ansi-blue-fg">(self, nrows, ncols, sharex, sharey, squeeze, width_ratios, height_ratios, subplot_kw, gridspec_kw)</span>
<span class="ansi-green-intense-fg ansi-bold">    890</span>         <span class="ansi-bold" style="color: rgb(0,135,0)">raise</span> <span class="ansi-bold" style="color: rgb(215,95,95)">ValueError</span>(<span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">width_ratios</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)"> must not be defined both as </span><span style="color: rgb(175,0,0)">&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">    891</span>                          <span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">parameter and as key in </span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">gridspec_kw</span><span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">&#34;</span>)
<span class="ansi-green-intense-fg ansi-bold">    892</span>     gridspec_kw[<span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">width_ratios</span><span style="color: rgb(175,0,0)">&#39;</span>] <span style="color: rgb(98,98,98)">=</span> width_ratios
<span class="ansi-green-fg">--&gt; 894</span> gs <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg">add_gridspec</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">nrows</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ncols</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">figure</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">*</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">*</span><span class="ansi-yellow-bg">gridspec_kw</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    895</span> axs <span style="color: rgb(98,98,98)">=</span> gs<span style="color: rgb(98,98,98)">.</span>subplots(sharex<span style="color: rgb(98,98,98)">=</span>sharex, sharey<span style="color: rgb(98,98,98)">=</span>sharey, squeeze<span style="color: rgb(98,98,98)">=</span>squeeze,
<span class="ansi-green-intense-fg ansi-bold">    896</span>                   subplot_kw<span style="color: rgb(98,98,98)">=</span>subplot_kw)
<span class="ansi-green-intense-fg ansi-bold">    897</span> <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> axs

File <span class="ansi-green-fg">~/.conda/envs/ion_suppression/lib/python3.10/site-packages/matplotlib/figure.py:1514</span>, in <span class="ansi-cyan-fg">FigureBase.add_gridspec</span><span class="ansi-blue-fg">(self, nrows, ncols, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1475</span> <span style="color: rgb(175,0,0)">&#34;&#34;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1476</span> <span style="color: rgb(175,0,0)">Return a `.GridSpec` that has this figure as a parent.  This allows</span>
<span class="ansi-green-intense-fg ansi-bold">   1477</span> <span style="color: rgb(175,0,0)">complex layout of Axes in the figure.</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-intense-fg ansi-bold">   1510</span>
<span class="ansi-green-intense-fg ansi-bold">   1511</span> <span style="color: rgb(175,0,0)">&#34;&#34;&#34;</span>
<span class="ansi-green-intense-fg ansi-bold">   1513</span> _ <span style="color: rgb(98,98,98)">=</span> kwargs<span style="color: rgb(98,98,98)">.</span>pop(<span style="color: rgb(175,0,0)">&#39;</span><span style="color: rgb(175,0,0)">figure</span><span style="color: rgb(175,0,0)">&#39;</span>, <span class="ansi-bold" style="color: rgb(0,135,0)">None</span>)  <span style="color: rgb(95,135,135)"># pop in case user has added this...</span>
<span class="ansi-green-fg">-&gt; 1514</span> gs <span style="color: rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">GridSpec</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">nrows</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">nrows</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ncols</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">ncols</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">figure</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg" style="color: rgb(0,135,0)">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">*</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1515</span> <span class="ansi-bold" style="color: rgb(0,135,0)">return</span> gs

File <span class="ansi-green-fg">~/.conda/envs/ion_suppression/lib/python3.10/site-packages/matplotlib/gridspec.py:388</span>, in <span class="ansi-cyan-fg">GridSpec.__init__</span><span class="ansi-blue-fg">(self, nrows, ncols, figure, left, bottom, right, top, wspace, hspace, width_ratios, height_ratios)</span>
<span class="ansi-green-intense-fg ansi-bold">    385</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>hspace <span style="color: rgb(98,98,98)">=</span> hspace
<span class="ansi-green-intense-fg ansi-bold">    386</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>figure <span style="color: rgb(98,98,98)">=</span> figure
<span class="ansi-green-fg">--&gt; 388</span> <span class="ansi-yellow-bg" style="color: rgb(0,135,0)">super</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">.</span><span class="ansi-yellow-bg" style="color: rgb(0,0,255)">__init__</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">nrows</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ncols</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    389</span> <span class="ansi-yellow-bg">                 </span><span class="ansi-yellow-bg">width_ratios</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">width_ratios</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    390</span> <span class="ansi-yellow-bg">                 </span><span class="ansi-yellow-bg">height_ratios</span><span class="ansi-yellow-bg" style="color: rgb(98,98,98)">=</span><span class="ansi-yellow-bg">height_ratios</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/.conda/envs/ion_suppression/lib/python3.10/site-packages/matplotlib/gridspec.py:52</span>, in <span class="ansi-cyan-fg">GridSpecBase.__init__</span><span class="ansi-blue-fg">(self, nrows, ncols, height_ratios, width_ratios)</span>
<span class="ansi-green-intense-fg ansi-bold">     49</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">raise</span> <span class="ansi-bold" style="color: rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-intense-fg ansi-bold">     50</span>         <span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Number of rows must be a positive integer, not </span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span>nrows<span class="ansi-bold" style="color: rgb(175,95,135)">!r}</span><span style="color: rgb(175,0,0)">&#34;</span>)
<span class="ansi-green-intense-fg ansi-bold">     51</span> <span class="ansi-bold" style="color: rgb(0,135,0)">if</span> <span class="ansi-bold" style="color: rgb(175,0,255)">not</span> <span style="color: rgb(0,135,0)">isinstance</span>(ncols, Integral) <span class="ansi-bold" style="color: rgb(175,0,255)">or</span> ncols <span style="color: rgb(98,98,98)">&lt;</span><span style="color: rgb(98,98,98)">=</span> <span style="color: rgb(98,98,98)">0</span>:
<span class="ansi-green-fg">---&gt; 52</span>     <span class="ansi-bold" style="color: rgb(0,135,0)">raise</span> <span class="ansi-bold" style="color: rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-intense-fg ansi-bold">     53</span>         <span style="color: rgb(175,0,0)">f</span><span style="color: rgb(175,0,0)">&#34;</span><span style="color: rgb(175,0,0)">Number of columns must be a positive integer, not </span><span class="ansi-bold" style="color: rgb(175,95,135)">{</span>ncols<span class="ansi-bold" style="color: rgb(175,95,135)">!r}</span><span style="color: rgb(175,0,0)">&#34;</span>)
<span class="ansi-green-intense-fg ansi-bold">     54</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>_nrows, <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>_ncols <span style="color: rgb(98,98,98)">=</span> nrows, ncols
<span class="ansi-green-intense-fg ansi-bold">     55</span> <span style="color: rgb(0,135,0)">self</span><span style="color: rgb(98,98,98)">.</span>set_height_ratios(height_ratios)

<span class="ansi-red-fg">ValueError</span>: Number of columns must be a positive integer, not 0
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Figure size 0x1500 with 0 Axes&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Using 65 pixels to calculate full-pixel avereage intensities.
Using 76 pixels to calculate full-pixel avereage intensities.
Using 78 pixels to calculate full-pixel avereage intensities.
Using 70 pixels to calculate full-pixel avereage intensities.
Using 54 pixels to calculate full-pixel avereage intensities.
Using 82 pixels to calculate full-pixel avereage intensities.
Using 79 pixels to calculate full-pixel avereage intensities.
</pre></div></div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/analysis/Mx_FDA/pipeline_01_correction.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Ion suppression correction  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">High-throughput ion suppression correction</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Marius Klein.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>