
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Ion suppression correction &#8212; Ion suppression correction  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/nature.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Ion suppression correction  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ion suppression correction</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<section id="Ion-suppression-correction">
<h1>Ion suppression correction<a class="headerlink" href="#Ion-suppression-correction" title="Permalink to this heading">Â¶</a></h1>
<p>This notebook establishes the correction workflow using the Co-Culture-Dataset of HeLa and NIH3T3 cells.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">statistics</span> <span class="k">as</span> <span class="nn">st</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">reload</span>
<span class="kn">import</span> <span class="nn">src.correction</span>
<span class="kn">from</span> <span class="nn">src.correction</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">src</span> <span class="kn">import</span> <span class="n">const</span>
<span class="kn">from</span> <span class="nn">src.evaluation</span> <span class="kn">import</span> <span class="n">plot_all_ion_slopes</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;Darwin&quot;</span><span class="p">:</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="s1">&#39;/Volumes/mklein/FDA_project/data/Mx_Co_Cultured&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">target_path</span> <span class="o">=</span> <span class="s1">&#39;/home/mklein/FDA_project/data/Mx_Co_Cultured&#39;</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dataset_co_cult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;data/Mx_Co_Cultured/marks_flitered_fluo.npy&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">dict_headers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;norm_MM&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cell_marks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;nucl_fluo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cell_fluo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marks_fluo&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marks_cell_overlap&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mark_area&quot;</span><span class="p">,</span>
    <span class="s2">&quot;overlap_indices&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marks_fluo_overlap&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cell_area&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marks_cell_overlap_indexes&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marks_cellLabels&quot;</span><span class="p">,</span>
    <span class="s2">&quot;marks_samplingArea&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pmi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;overLaps&quot;</span><span class="p">]</span>

<span class="n">cell_area</span> <span class="o">=</span> <span class="n">dataset_co_cult</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span>

<span class="c1"># reference, which cells are covered by which marks</span>
<span class="n">cell_marks</span> <span class="o">=</span> <span class="n">dataset_co_cult</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># size of every mark</span>
<span class="n">mark_area</span> <span class="o">=</span> <span class="n">dataset_co_cult</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span>

<span class="c1"># reference of overlap area between cells and marks</span>
<span class="n">marks_cell_overlap</span> <span class="o">=</span> <span class="n">dataset_co_cult</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pickles of tables that result from this comfiguration have suffix &quot;_small&quot;</span>
<span class="k">if</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">selected_cells</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;100&#39;</span><span class="p">,</span> <span class="s1">&#39;21&#39;</span><span class="p">,</span> <span class="s1">&#39;43&#39;</span><span class="p">,</span> <span class="s1">&#39;547&#39;</span><span class="p">]</span>
    <span class="n">cell_marks</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">cell_marks</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">selected_cells</span><span class="p">}</span>
    <span class="n">marks_cell_overlap</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">marks_cell_overlap</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">selected_cells</span><span class="p">}</span>
    <span class="n">selected_pixels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">cell_marks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">selected_pixels</span> <span class="o">=</span> <span class="n">selected_pixels</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell</span><span class="p">]</span>

    <span class="n">selected_pixels</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span> <span class="o">=</span> <span class="nb">int</span><span class="p">)</span>
    <span class="n">mark_area</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">mark_area</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">selected_pixels</span><span class="p">}</span>

    <span class="n">selected_pixels</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># calculating different cell x pixel matrices</span>
<span class="n">overlap_matrix</span><span class="p">,</span> <span class="n">sampling_spec_matrix</span> <span class="o">=</span> <span class="n">get_matrices</span><span class="p">(</span><span class="n">mark_area</span><span class="o">=</span><span class="n">mark_area</span><span class="p">,</span> <span class="n">marks_cell_associations</span><span class="o">=</span><span class="n">cell_marks</span><span class="p">,</span> <span class="n">marks_cell_overlap</span><span class="o">=</span><span class="n">marks_cell_overlap</span><span class="p">)</span>

<span class="n">sampling_spec_matrix</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
      <th>...</th>
      <th>2490</th>
      <th>2491</th>
      <th>2492</th>
      <th>2493</th>
      <th>2494</th>
      <th>2495</th>
      <th>2496</th>
      <th>2497</th>
      <th>2498</th>
      <th>2499</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1570</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1571</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1572</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1573</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1574</th>
      <td>0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>...</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>1572 rows Ã 2500 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ion_intensities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/Mx_Co_Cultured/sm_annotation_detections.csv&#39;</span><span class="p">)</span>

<span class="n">ion_intensities</span> <span class="o">=</span> <span class="n">ion_intensities</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;Num&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ion_intensities = ion_intensities[[&#39;C16H30O2&#39;, &quot;C25H44NO7P&quot;, &quot;C45H78NO8P&quot;]]</span>
<span class="c1"># ion_intensities = ion_intensities.iloc[selected_pixels]</span>

<span class="n">ion_intensities</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">PIXEL_PRE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ion_intensities</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
<span class="n">ion_intensities</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>C10H10N2O3S</th>
      <th>C10H10N2O4S</th>
      <th>C12H13N3O4S</th>
      <th>C12H20N3O6S</th>
      <th>C13H16N2O5</th>
      <th>C13H26O2</th>
      <th>C14H20N2O3S</th>
      <th>C14H20N2O4S</th>
      <th>C14H20N2O6S</th>
      <th>C14H21N3O3S</th>
      <th>...</th>
      <th>C45H78NO8P</th>
      <th>C45H80NO8P</th>
      <th>C45H82NO7P</th>
      <th>C45H82NO8P</th>
      <th>C46H77O10P</th>
      <th>C46H81NO10P</th>
      <th>C50H84NO10P</th>
      <th>C6H11O8P</th>
      <th>C6H13O9P</th>
      <th>C9H19O11P</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>11732.452</td>
      <td>996.42834</td>
      <td>0.000000</td>
      <td>96.63648</td>
      <td>251.41237</td>
      <td>1035.7161</td>
      <td>508.46760</td>
      <td>776.2968</td>
      <td>728.43120</td>
      <td>1268.3046</td>
      <td>...</td>
      <td>263.37576</td>
      <td>252.51741</td>
      <td>0.0</td>
      <td>244.01695</td>
      <td>0.00000</td>
      <td>99.36901</td>
      <td>0.0</td>
      <td>2732.2040</td>
      <td>1450.11540</td>
      <td>128.282870</td>
    </tr>
    <tr>
      <th>1</th>
      <td>8926.941</td>
      <td>644.85220</td>
      <td>98.860180</td>
      <td>94.53568</td>
      <td>129.45300</td>
      <td>1127.7477</td>
      <td>660.01980</td>
      <td>798.9810</td>
      <td>499.13810</td>
      <td>1126.1990</td>
      <td>...</td>
      <td>269.30545</td>
      <td>126.23382</td>
      <td>0.0</td>
      <td>491.70282</td>
      <td>340.28522</td>
      <td>75.63770</td>
      <td>0.0</td>
      <td>4471.3240</td>
      <td>1770.75710</td>
      <td>400.891660</td>
    </tr>
    <tr>
      <th>2</th>
      <td>16184.508</td>
      <td>1443.74080</td>
      <td>122.435680</td>
      <td>459.26910</td>
      <td>298.34604</td>
      <td>874.1114</td>
      <td>869.47440</td>
      <td>1570.6218</td>
      <td>1599.04420</td>
      <td>1897.0496</td>
      <td>...</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>970.5054</td>
      <td>616.07654</td>
      <td>78.222760</td>
    </tr>
    <tr>
      <th>3</th>
      <td>17386.785</td>
      <td>1770.08830</td>
      <td>0.000000</td>
      <td>521.62244</td>
      <td>392.64360</td>
      <td>1581.3160</td>
      <td>851.89560</td>
      <td>1496.8848</td>
      <td>1700.58310</td>
      <td>2238.6267</td>
      <td>...</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>1037.3005</td>
      <td>702.37850</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>17993.777</td>
      <td>2441.13100</td>
      <td>0.000000</td>
      <td>424.59857</td>
      <td>589.03710</td>
      <td>1536.0576</td>
      <td>1004.76526</td>
      <td>1373.1233</td>
      <td>1684.19860</td>
      <td>2142.4817</td>
      <td>...</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>1332.7043</td>
      <td>940.42100</td>
      <td>120.620830</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2495</th>
      <td>14193.198</td>
      <td>1098.00960</td>
      <td>377.735440</td>
      <td>133.33331</td>
      <td>0.00000</td>
      <td>1268.6356</td>
      <td>966.20984</td>
      <td>1225.4326</td>
      <td>1056.80550</td>
      <td>2004.0934</td>
      <td>...</td>
      <td>130.08005</td>
      <td>229.90854</td>
      <td>0.0</td>
      <td>136.83795</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>4241.5864</td>
      <td>1591.95830</td>
      <td>317.245880</td>
    </tr>
    <tr>
      <th>2496</th>
      <td>17826.373</td>
      <td>2204.89750</td>
      <td>124.410450</td>
      <td>604.37280</td>
      <td>635.19990</td>
      <td>1172.6652</td>
      <td>2027.87210</td>
      <td>2225.9185</td>
      <td>2475.11870</td>
      <td>3223.1426</td>
      <td>...</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>2617.0530</td>
      <td>1362.17570</td>
      <td>85.987526</td>
    </tr>
    <tr>
      <th>2497</th>
      <td>20524.766</td>
      <td>2208.07860</td>
      <td>131.849640</td>
      <td>535.55316</td>
      <td>437.42600</td>
      <td>1162.7046</td>
      <td>1485.94580</td>
      <td>1914.0786</td>
      <td>1891.50900</td>
      <td>3095.1462</td>
      <td>...</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.0</td>
      <td>3441.5498</td>
      <td>2130.13530</td>
      <td>101.250000</td>
    </tr>
    <tr>
      <th>2498</th>
      <td>13827.365</td>
      <td>1398.90610</td>
      <td>117.092980</td>
      <td>228.95663</td>
      <td>93.65218</td>
      <td>922.5511</td>
      <td>1030.80410</td>
      <td>1423.4183</td>
      <td>1002.28130</td>
      <td>2138.9333</td>
      <td>...</td>
      <td>184.42477</td>
      <td>230.75467</td>
      <td>0.0</td>
      <td>108.41697</td>
      <td>0.00000</td>
      <td>368.53442</td>
      <td>0.0</td>
      <td>5551.5240</td>
      <td>2327.51880</td>
      <td>254.901870</td>
    </tr>
    <tr>
      <th>2499</th>
      <td>8309.413</td>
      <td>777.50710</td>
      <td>54.968914</td>
      <td>0.00000</td>
      <td>68.58983</td>
      <td>1171.5669</td>
      <td>582.49270</td>
      <td>802.6624</td>
      <td>265.93088</td>
      <td>1357.9442</td>
      <td>...</td>
      <td>184.74634</td>
      <td>134.13509</td>
      <td>0.0</td>
      <td>403.94885</td>
      <td>0.00000</td>
      <td>200.95474</td>
      <td>0.0</td>
      <td>7431.5723</td>
      <td>3101.31710</td>
      <td>669.905700</td>
    </tr>
  </tbody>
</table>
<p>2500 rows Ã 104 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">am_adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="n">ion_intensities</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># this is how martijn performed the calculations</span>
<span class="k">def</span> <span class="nf">cell_normalization_Rappez_matrix</span><span class="p">(</span><span class="n">sampling_prop_matrix</span><span class="p">,</span> <span class="n">sampling_spec_matrix</span><span class="p">,</span> <span class="n">ion_intensity_matrix</span><span class="p">,</span> <span class="n">sampling_prop_threshold</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">sampling_spec_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>

    <span class="c1"># filter out pixels with little overlap with any cell (thus sum of all overlaps)</span>
    <span class="n">pixel_sampling_prop_keep</span> <span class="o">=</span> <span class="n">sampling_prop_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sampling_prop_threshold</span>
    <span class="c1"># filter out pixels with low contributions to a cell</span>
    <span class="n">pixel_sampling_spec_keep</span> <span class="o">=</span> <span class="n">sampling_spec_matrix</span> <span class="o">&gt;</span> <span class="n">sampling_spec_threshold</span>

    <span class="n">sampling_prop_matrix_filtered</span> <span class="o">=</span> <span class="n">sampling_prop_matrix</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">pixel_sampling_prop_keep</span>
    <span class="n">sampling_spec_matrix_filtered</span> <span class="o">=</span> <span class="n">sampling_spec_matrix</span> <span class="o">*</span> <span class="n">pixel_sampling_spec_keep</span>

    <span class="n">sum_prop_matrix</span> <span class="o">=</span> <span class="n">sampling_prop_matrix_filtered</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">to_replace</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>

    <span class="c1"># create dataframe for results</span>
    <span class="n">norm_ion_intensities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">sampling_prop_matrix_filtered</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">ion_intensity_matrix</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">norm_spots</span> <span class="o">=</span> <span class="n">ion_intensity_matrix</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sum_prop_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">cor_df</span> <span class="o">=</span> <span class="n">sampling_spec_matrix_filtered</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">norm_spots</span><span class="p">)</span>

    <span class="n">norm_cor_df</span> <span class="o">=</span> <span class="n">cor_df</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sampling_spec_matrix_filtered</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">norm_cor_df</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reload</span><span class="p">(</span><span class="n">src</span><span class="o">.</span><span class="n">correction</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">src.correction</span> <span class="kn">import</span> <span class="n">add_normalization_factors</span><span class="p">,</span> <span class="n">correct_quantile_inplace</span>

<span class="n">add_matrices</span><span class="p">(</span><span class="n">adata</span> <span class="o">=</span> <span class="n">am_adata</span><span class="p">,</span>
    <span class="n">overlap_matrix</span> <span class="o">=</span> <span class="n">overlap_matrix</span><span class="p">,</span>
    <span class="n">sampling_spec_matrix</span> <span class="o">=</span> <span class="n">sampling_spec_matrix</span><span class="p">)</span>

<span class="n">add_normalization_factors</span><span class="p">(</span><span class="n">adata</span> <span class="o">=</span> <span class="n">am_adata</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">median</span><span class="p">)</span>

<span class="n">corrected_intensities</span> <span class="o">=</span> <span class="n">correct_quantile_inplace</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span>
    <span class="n">reference_ions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C21H43O7P&#39;</span><span class="p">],</span>
    <span class="n">correct_intersect</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/mariusklein/opt/anaconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.
  warnings.warn(&#34;Maximum number of iterations (&#34; + str(max_iter) +
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">condition_metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="s1">&#39;MORPHnMOL.csv&#39;</span><span class="p">))</span>
<span class="n">condition_metadata</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">CELL_PRE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">condition_metadata</span><span class="o">.</span><span class="n">ObjectNumber</span><span class="p">]</span>
<span class="n">condition_metadata</span><span class="p">[</span><span class="s1">&#39;GFP&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_metadata</span><span class="o">.</span><span class="n">Intensity_MeanIntensity_GFP_quantif</span>
<span class="n">condition_metadata</span><span class="p">[</span><span class="s1">&#39;MCherry&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">condition_metadata</span><span class="o">.</span><span class="n">Intensity_MeanIntensity_mCherry_quantif</span>
<span class="n">condition_metadata</span><span class="p">[</span><span class="s1">&#39;fluorescence_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">condition_metadata</span><span class="o">.</span><span class="n">GFP</span> <span class="o">/</span> <span class="n">condition_metadata</span><span class="o">.</span><span class="n">MCherry</span><span class="p">)</span>

<span class="c1">#condition_metadata[&#39;celltype&#39;] = &#39;HeLa&#39; if condition_metadata.fluorescence_ratio &lt; 0.8 else &#39;NIH3T3&#39;</span>
<span class="n">condition_metadata</span><span class="p">[</span><span class="s1">&#39;celltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">condition_metadata</span><span class="o">.</span><span class="n">fluorescence_ratio</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;HeLa&#39;</span><span class="p">,</span> <span class="s1">&#39;NIH3T3&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">condition_metadata</span><span class="p">[</span><span class="s1">&#39;celltype&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

<span class="n">plot</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">relplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">condition_metadata</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;GFP&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;MCherry&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;celltype&#39;</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plot</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cell type attributation based on GFP / MCherry fluorescence ratio&#39;</span><span class="p">)</span>

<span class="n">raw_adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">obs</span><span class="o">=</span><span class="n">condition_metadata</span><span class="p">[[</span><span class="s1">&#39;ObjectNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;celltype&#39;</span><span class="p">,</span> <span class="s1">&#39;GFP&#39;</span><span class="p">,</span> <span class="s1">&#39;MCherry&#39;</span><span class="p">,</span> <span class="s1">&#39;fluorescence_ratio&#39;</span><span class="p">]],</span> <span class="n">var</span><span class="o">=</span><span class="n">am_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">am_adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">condition_metadata</span><span class="o">.</span><span class="n">columns</span><span class="p">)])</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
HeLa      715
NIH3T3    492
Name: celltype, dtype: int64
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_10_1.png" src="_images/ion_suppression_correction_10_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_adata</span> <span class="o">=</span> <span class="n">deconvolution_rappez</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">raw_adata</span><span class="o">=</span><span class="n">raw_adata</span><span class="p">)</span>
<span class="n">corr_cell_adata</span> <span class="o">=</span> <span class="n">deconvolution_rappez</span><span class="p">(</span><span class="n">corrected_intensities</span><span class="p">,</span> <span class="n">raw_adata</span><span class="o">=</span><span class="n">raw_adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">log_log_regression_plot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">molecule</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">x_axis_name</span><span class="o">=</span><span class="s1">&#39;sampling_proportion&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Regression plot&#39;</span><span class="p">,</span> <span class="n">log_axis</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    <span class="n">intensities_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;correction_quantreg_intersect&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">intersect</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">molecule</span><span class="p">,</span> <span class="s1">&#39;correction_quantreg_intersect&#39;</span><span class="p">]</span>
        <span class="n">slope</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">molecule</span><span class="p">,</span> <span class="s1">&#39;correction_quantreg_slope&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y = </span><span class="si">%1.2f</span><span class="s1">x + </span><span class="si">%1.2f</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">slope</span><span class="p">,</span><span class="n">intersect</span><span class="p">))</span>

    <span class="n">x_axis</span> <span class="o">=</span> <span class="n">total_pixel_overlap</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;correction_total_pixel_overlap&#39;</span><span class="p">]</span>
    <span class="n">full_pixel_intensities</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;correction_full_pixel_avg_intensities&#39;</span><span class="p">]</span>
    <span class="n">norm_intensity_prop_ratios_df</span> <span class="o">=</span> <span class="n">normalize_proportion_ratios</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
    <span class="n">intensities_df</span><span class="p">[</span><span class="n">x_axis_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_pixel_overlap</span>
    <span class="n">norm_intensity_prop_ratios_df</span><span class="p">[</span><span class="n">x_axis_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_pixel_overlap</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">intensities_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">molecule</span> <span class="o">=</span> <span class="n">intensities_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">log_axis</span><span class="p">:</span>
        <span class="n">intensities_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">intensities_df</span><span class="p">)</span>
        <span class="n">norm_intensity_prop_ratios_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">norm_intensity_prop_ratios_df</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render_plot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">measure</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">):</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span> <span class="o">=</span> <span class="p">[</span><span class="n">molecule</span><span class="p">,</span> <span class="n">x_axis_name</span><span class="p">])</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="n">x_axis_name</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">log_axis</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">yscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span> <span class="n">measure</span> <span class="o">+</span> <span class="s2">&quot; of &quot;</span> <span class="o">+</span> <span class="n">molecule</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

    <span class="n">render_plot</span><span class="p">(</span><span class="n">intensities_df</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">measure</span> <span class="o">=</span> <span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="n">title</span><span class="p">)</span>
    <span class="n">render_plot</span><span class="p">(</span><span class="n">norm_intensity_prop_ratios_df</span><span class="p">,</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">measure</span> <span class="o">=</span> <span class="s1">&#39;norm. intensity/sampling prop. ratio&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;intens./sampling prop. ratio&#39;</span><span class="p">)</span>

    <span class="c1"># if &#39;correction_quantreg_intersect&#39; in list(df.var.columns):</span>
        <span class="c1"># ax[1].axline((0, intersect), slope=slope)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">log_log_regression_plot</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="s1">&#39;C20H32O2&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;raw intensities&#39;</span><span class="p">)</span>
<span class="n">log_log_regression_plot</span><span class="p">(</span><span class="n">corrected_intensities</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="s1">&#39;C20H32O2&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;corrected intensities&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
y = 0.06x + -0.08
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_13_1.png" src="_images/ion_suppression_correction_13_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_13_2.png" src="_images/ion_suppression_correction_13_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">log_log_regression_plot</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="s1">&#39;C16H30O2&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;raw intensities&#39;</span><span class="p">)</span>
<span class="n">log_log_regression_plot</span><span class="p">(</span><span class="n">corrected_intensities</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="s1">&#39;C16H30O2&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;corrected intensities&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
y = -0.49x + -0.02
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_14_1.png" src="_images/ion_suppression_correction_14_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_14_2.png" src="_images/ion_suppression_correction_14_2.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">log_log_regression_plot</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="s1">&#39;C21H43O7P&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;raw intensities&#39;</span><span class="p">)</span>
<span class="n">log_log_regression_plot</span><span class="p">(</span><span class="n">corrected_intensities</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="s1">&#39;C21H43O7P&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;corrected intensities&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
y = -1.00x + 0.01
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_15_1.png" src="_images/ion_suppression_correction_15_1.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_15_2.png" src="_images/ion_suppression_correction_15_2.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_adata</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="s1">&#39;pipeline_files/batch_sm_matrix.h5ad&#39;</span><span class="p">))</span>
<span class="n">corr_cell_adata</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="s1">&#39;pipeline_files/corrected_batch_sm_matrix.h5ad&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">am_adata</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="s1">&#39;pipeline_files/am_sm_matrix.h5ad&#39;</span><span class="p">))</span>
<span class="n">corrected_intensities</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">target_path</span><span class="p">,</span> <span class="s1">&#39;pipeline_files/corrected_am_sm_matrix.h5ad&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Different molecules are changed by the ion suppression correction to a different extent. This is not only determined by the data at hand but also by the regression method employed. In the following, the results of quantile regression and other regression methods are shown on different representative molecules. In total on two molecules, quantile regression results in a positive relationship between intensity / sampling proportion ratio and sampling proportion. This is not expected and also does
not reflect the visual impression of the regression plot. Other methods, albeit resulting in a negative slope, are also unable to align with the precepted relationship.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="n">sparse_overlap</span> <span class="o">=</span> <span class="n">csr_matrix</span><span class="p">(</span><span class="n">am_adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;correction_overlap_matrix&#39;</span><span class="p">])</span>
<span class="n">dict_assoc</span> <span class="o">=</span> <span class="n">sparse_overlap</span><span class="o">.</span><span class="n">tocoo</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">overlap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;am&#39;</span><span class="p">:</span> <span class="n">dict_assoc</span><span class="o">.</span><span class="n">row</span><span class="p">,</span> <span class="s1">&#39;ObjectNumber&#39;</span><span class="p">:</span> <span class="n">dict_assoc</span><span class="o">.</span><span class="n">col</span><span class="p">})</span>
<span class="n">overlap_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">,</span> <span class="n">cell_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s1">&#39;ObjectNumber&#39;</span><span class="p">,</span> <span class="s1">&#39;celltype&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;ObjectNumber&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
<span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;celltype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;celltype&#39;</span><span class="p">],</span> <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;HeLa&#39;</span><span class="p">,</span> <span class="s1">&#39;NIH3T3&#39;</span><span class="p">,</span> <span class="s1">&#39;mixed&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">])</span>
<span class="n">am_adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;cell_condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">([</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">overlap_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="n">am</span><span class="p">,</span> <span class="s1">&#39;celltype&#39;</span><span class="p">])))</span>
    <span class="k">if</span> <span class="n">am</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">overlap_df</span><span class="p">[</span><span class="s1">&#39;am&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
    <span class="k">else</span> <span class="s1">&#39;none&#39;</span>
    <span class="k">for</span> <span class="n">am</span> <span class="ow">in</span> <span class="n">am_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="n">norm_int</span> <span class="o">=</span> <span class="n">src</span><span class="o">.</span><span class="n">correction</span><span class="o">.</span><span class="n">normalize_proportion_ratios</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">normalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_different_regressions</span><span class="p">(</span><span class="n">ion</span><span class="p">):</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">obs_df</span><span class="p">(</span><span class="n">norm_int</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">ion</span><span class="p">,</span> <span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">])</span>
    <span class="n">plot_df</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">Inf</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">plot_df</span> <span class="o">=</span> <span class="n">plot_df</span><span class="p">[</span><span class="n">plot_df</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)]</span>
    <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;full&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;full&#39;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="s1">&#39;not full&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plot_df</span><span class="p">[</span><span class="n">const</span><span class="o">.</span><span class="n">TPO</span><span class="p">]]</span>
    <span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;am&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_df</span><span class="o">.</span><span class="n">index</span>
    <span class="n">plot_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">norm_int</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s1">&#39;cell_condition&#39;</span><span class="p">]],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;correction_total_pixel_overlap&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ion</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;cell_condition&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;cividis&#39;</span><span class="p">)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">plot_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;correction_total_pixel_overlap&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">ion</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axline</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">slope</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">qrmodel</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">quantreg</span><span class="p">(</span><span class="n">ion</span><span class="o">+</span><span class="s1">&#39; ~ correction_total_pixel_overlap&#39;</span><span class="p">,</span> <span class="n">plot_df</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axline</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">qrmodel</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">slope</span><span class="o">=</span><span class="n">qrmodel</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;quantreg&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="n">ion</span><span class="p">],</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;correction_total_pixel_overlap&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axline</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">slope</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;OLS&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">RLM</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="n">ion</span><span class="p">],</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">plot_df</span><span class="p">[</span><span class="s1">&#39;correction_total_pixel_overlap&#39;</span><span class="p">]),</span> <span class="n">M</span><span class="o">=</span><span class="n">sm</span><span class="o">.</span><span class="n">robust</span><span class="o">.</span><span class="n">norms</span><span class="o">.</span><span class="n">HuberT</span><span class="p">())</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axline</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">slope</span><span class="o">=</span><span class="n">model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;RLM&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span>
        <span class="n">a</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;log.-norm. intensity / sampling proportion ratio&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;log sampling proportion&#39;</span><span class="p">)</span>

    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="n">ion</span> <span class="o">+</span> <span class="s2">&quot;: distribution of conditions&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span> <span class="o">=</span> <span class="n">ion</span> <span class="o">+</span> <span class="s2">&quot;: regression methods&quot;</span><span class="p">)</span>

    <span class="c1"># print(&quot;full pixel average intensity %s: %1.1f&quot;%(ion, norm_int.var.loc[ion, const.FPAI]))</span>
    <span class="c1">#print(qrmodel.params)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">plot_df</span>


<span class="n">arach_df</span> <span class="o">=</span> <span class="n">plot_different_regressions</span><span class="p">(</span><span class="n">ion</span> <span class="o">=</span> <span class="s1">&#39;C20H32O2&#39;</span><span class="p">)</span>
<span class="n">plot_different_regressions</span><span class="p">(</span><span class="n">ion</span> <span class="o">=</span> <span class="s1">&#39;C43H81O13P&#39;</span><span class="p">)</span>
<span class="n">plot_different_regressions</span><span class="p">(</span><span class="n">ion</span> <span class="o">=</span> <span class="s1">&#39;C41H80NO8P&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plot_different_regressions</span><span class="p">(</span><span class="n">ion</span> <span class="o">=</span> <span class="s1">&#39;C19H37O6P&#39;</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/mariusklein/opt/anaconda3/envs/ion_suppression/lib/python3.10/site-packages/pandas/core/internals/blocks.py:351: RuntimeWarning: divide by zero encountered in log10
  result = func(self.values, **kwargs)
/Users/mariusklein/opt/anaconda3/envs/ion_suppression/lib/python3.10/site-packages/pandas/core/internals/blocks.py:351: RuntimeWarning: divide by zero encountered in log10
  result = func(self.values, **kwargs)
/Users/mariusklein/opt/anaconda3/envs/ion_suppression/lib/python3.10/site-packages/pandas/core/internals/blocks.py:351: RuntimeWarning: divide by zero encountered in log10
  result = func(self.values, **kwargs)
/Users/mariusklein/opt/anaconda3/envs/ion_suppression/lib/python3.10/site-packages/pandas/core/internals/blocks.py:351: RuntimeWarning: divide by zero encountered in log10
  result = func(self.values, **kwargs)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_21_1.png" src="_images/ion_suppression_correction_21_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_21_2.png" src="_images/ion_suppression_correction_21_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_21_3.png" src="_images/ion_suppression_correction_21_3.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_21_4.png" src="_images/ion_suppression_correction_21_4.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_all_ion_slopes</span><span class="p">(</span><span class="n">am_adata</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">raw_adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/mariusklein/opt/anaconda3/envs/ion_suppression/lib/python3.10/site-packages/pandas/core/internals/blocks.py:351: RuntimeWarning: divide by zero encountered in log10
  result = func(self.values, **kwargs)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_22_1.png" src="_images/ion_suppression_correction_22_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_all_ion_slopes</span><span class="p">(</span><span class="n">corrected_intensities</span><span class="p">,</span> <span class="n">subset</span> <span class="o">=</span> <span class="n">raw_adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/mariusklein/opt/anaconda3/envs/ion_suppression/lib/python3.10/site-packages/pandas/core/internals/blocks.py:351: RuntimeWarning: divide by zero encountered in log10
  result = func(self.values, **kwargs)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="_images/ion_suppression_correction_23_1.png" src="_images/ion_suppression_correction_23_1.png" />
</div>
</div>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/ion_suppression_correction.ipynb.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="index.html">Ion suppression correction  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ion suppression correction</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Marius Klein.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 5.3.0.
    </div>
  </body>
</html>