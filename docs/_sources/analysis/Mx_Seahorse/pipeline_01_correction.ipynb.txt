{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "41b377a3",
   "metadata": {
    "papermill": {
     "duration": 0.010984,
     "end_time": "2023-01-15T13:05:39.649713",
     "exception": false,
     "start_time": "2023-01-15T13:05:39.638729",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "# Mx_Seahorse: Correction\n",
    "\n",
    "SpaceM datasets are usually stored as annotated data-matrices, separately for individual wells. With this notebooks, these individual files are corrected for ion suppression on the pixel-level and then deconvoluted to cell-level. All resulting files are saved separately by well to the target_path and the impact of the correction briefly shown for visual inspection."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "5116d622",
   "metadata": {
    "papermill": {
     "duration": 105.576559,
     "end_time": "2023-01-15T13:07:25.240428",
     "exception": false,
     "start_time": "2023-01-15T13:05:39.663869",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import os\n",
    "import platform\n",
    "import scanpy as sc\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import anndata as ad\n",
    "import statistics as st\n",
    "import multiprocessing\n",
    "from joblib import Parallel, delayed\n",
    "from tqdm import tqdm\n",
    "import statsmodels.formula.api as smf\n",
    "import seaborn as sns\n",
    "import re\n",
    "from importlib import reload\n",
    "import json\n",
    "import sys\n",
    "sys.path.append('/home/mklein/spacem')\n",
    "sys.path.append('/home/mklein/FDA_project')\n",
    "\n",
    "from src.correction import (add_normalization_factors, \n",
    "                            correct_quantile_inplace,\n",
    "                            deconvolution_spacem,\n",
    "                            get_overlap_data,\n",
    "                            add_overlap_matrix_spacem,\n",
    "                            get_reference_pool\n",
    "                           )\n",
    "from src import const \n",
    "from SpaceM.lib.modules import (\n",
    "    overlap_analysis,\n",
    "    single_cell_analysis_normalization\n",
    ")\n",
    "\n",
    "%matplotlib inline"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bdb54d29",
   "metadata": {
    "papermill": {
     "duration": 0.065839,
     "end_time": "2023-01-15T13:07:25.336171",
     "exception": false,
     "start_time": "2023-01-15T13:07:25.270332",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "The original data lies on the groups shared data storage. Corrected files will be saved in a separate location, preserving the well-specific folder structure."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "bdb2cdfe",
   "metadata": {
    "papermill": {
     "duration": 0.034452,
     "end_time": "2023-01-15T13:07:25.455773",
     "exception": false,
     "start_time": "2023-01-15T13:07:25.421321",
     "status": "completed"
    },
    "tags": [
     "parameters"
    ]
   },
   "outputs": [],
   "source": [
    "if platform.system() == \"Darwin\":\n",
    "    source_path = '/Volumes/alexandr/smenon/2022-07-13_Glioblastoma/processed_files'\n",
    "    target_path = '/Volumes/mklein/FDA_project/data/Lx_Glioblastoma'\n",
    "else:\n",
    "    source_path = '/g/alexandr/smenon/2022-07-13_Glioblastoma/processed_files'\n",
    "    target_path = '/home/mklein/FDA_project/data/Lx_Glioblastoma'\n",
    "    \n",
    "\n",
    "deconv_default_min_overlap = 0.0"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "5cd0e384",
   "metadata": {
    "papermill": {
     "duration": 0.090953,
     "end_time": "2023-01-15T13:07:25.607554",
     "exception": false,
     "start_time": "2023-01-15T13:07:25.516601",
     "status": "completed"
    },
    "tags": [
     "injected-parameters"
    ]
   },
   "outputs": [],
   "source": [
    "# Parameters\n",
    "source_path = \"/home/mklein/Raw Data/220412_Luisa_ScSeahorse_SpaceM\"\n",
    "target_path = \"/home/mklein/FDA_project/data/Mx_Seahorse\"\n",
    "condition_name = \"treatment\"\n",
    "well_name = \"rowcol\"\n",
    "analysis_path = \"/home/mklein/FDA_project/analysis/Mx_Seahorse\"\n",
    "notebooks = [\n",
    "    \"pipeline_01_correction.ipynb\",\n",
    "    \"pipeline_02_processing.ipynb\",\n",
    "    \"pipeline_03_evaluation.ipynb\",\n",
    "]\n",
    "project = \"Mx_Seahorse\"\n",
    "correction_proportion_threshold = 0.01"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "cb2a145c",
   "metadata": {
    "papermill": {
     "duration": 2.258719,
     "end_time": "2023-01-15T13:07:28.001670",
     "exception": false,
     "start_time": "2023-01-15T13:07:25.742951",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "data": {
      "text/plain": [
       "'A2, A3, B1, B3, B4, C1, D1, E1, E2, E3, E4, F2, F3, F4, G1, G4, H3, H4, J2'"
      ]
     },
     "execution_count": 4,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "samples = []\n",
    "for dirpath, dirnames, filenames in os.walk(source_path):\n",
    "        if 'analysis' in dirnames:\n",
    "            samples.append(re.sub(source_path+'/?', '', dirpath))\n",
    "\", \".join(samples)"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "9560c901",
   "metadata": {
    "papermill": {
     "duration": 0.135172,
     "end_time": "2023-01-15T13:07:28.281254",
     "exception": false,
     "start_time": "2023-01-15T13:07:28.146082",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "files = {\n",
    "        'config': '../config.json',\n",
    "        'sm_matrix': 'ablation_mark_analysis/spatiomolecular_adata.h5ad',\n",
    "        'overlap_regions': 'overlap_analysis2/overlap.regions.csv',\n",
    "        'mark_regions': 'overlap_analysis2/ablation_mark.regions.csv',\n",
    "        'cell_regions': 'overlap_analysis2/cell.regions.csv',\n",
    "        'cell_sm_matrix': 'single_cell_analysis/spatiomolecular_adata.h5ad',\n",
    "    }"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "831a58d3-d371-412d-8404-fab9f5d90beb",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "<AxesSubplot: xlabel='am_area', ylabel='Count'>"
      ]
     },
     "execution_count": 6,
     "metadata": {},
     "output_type": "execute_result"
    },
    {
     "data": {
      "image/png": "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66WXXrLa2tosh8NhPf3005593377rWW3260XXnjB0xYREWG98sorXseIjo62XnrpJZ/V3BOdXOfvq66utiRZH330kVf7N998Y4WEhFglJSWeti+//NLq06ePtWnTJl+U22N1ZJ3b89prr1l9+/a1jh071k0V9h6dWevKykrrkksusWpqaixJ1oYNG7q/0B6uo+s8evRo6/HHH/dRdb1HR9fZl6+FRNluduLECZWUlOjIkSMaM2aMqqurVVtbq6ysLE+f0NBQjRs3Tjt27PC0XXvttXr11Vd1+PBhtbW1qaSkRC0tLRo/frwfZhH4Tl3nc1FRUaFjx455/V0kJCQoLS3N6+8C/68z69yehoYGRUVFKTjYmM+G7bDOrvXRo0f1s5/9TMuWLZPD4ejGCnuHzqxzXV2d3n//fQ0YMEBjx45VXFycxo0bp7Kysm6utufq7M+zL18L+deom+zatUtjxozRt99+qwsuuEAbNmzQsGHDPC+0p36pbFxcnL744gvP41dffVV33HGHYmJiFBwcrPDwcG3YsEGXXnqpT+cR6M60zueitrZWffv2Vf/+/b3a4+LiTvsiYNOdzzqf6uuvv9ZvfvMb5eTkdHGVvcP5rvVDDz2ksWPH6rbbbuvGKnu+81nnzz//XJKUl5enZ599VldddZVeeeUVZWZmqqqqSqmpqd1Zeo9yvj/PvnwtJBB1k8GDB6uyslLffPON/vznP+uuu+7Stm3bPPtPfW/fsiyvtscff1z19fXasmWLYmNj9cYbb+j222/X9u3blZ6e7rN5BLozrXNnX6yl0/8u0HXr3NjYqFtuuUXDhg3TwoULu6nanu181nrjxo16++23udbwHJzPOre1tUmScnJy9Mtf/lKSNGLECG3dulUrV65UQUFBt9bek5zvvx0+fS3s8jfh0K7MzEzr3nvvtT777DNLkvXhhx967Z88ebL1i1/8wrIsy/r0008tSVZVVdVpx8jJyfFZzT3RyXX+vjO9P71161ZLknX48GGv9uHDh1tPPPFEd5fao3VknU9qbGy0xowZY2VmZlput9sHVfYOHVnrBx980LLZbFZQUJBnk2T16dPHGjdunO+K7oE6ss6ff/65Jclau3atV/vUqVOtadOmdXepPVpH1tnXr4VcQ+QjlmWppaVFKSkpcjgcKi0t9exrbW3Vtm3bNHbsWEnfXQMg6bS7FYKCgjz/M0H7Tq7zucjIyFBISIjX30VNTY2qqqo8fxdoX0fWWfruzFBWVpb69u2rjRs3ql+/ft1YXe/SkbV+7LHH9PHHH6uystKzSdLSpUu1atWqbqyy5+vIOicnJyshIUH79u3zav/kk0/8/oXhga4j6+zr10LeMusG//Ef/6GbbrpJiYmJampqUklJid59911t2rRJNptNubm5ys/PV2pqqlJTU5Wfn6/w8HBNmzZNkjRkyBBddtllysnJ0bPPPquYmBi98cYbKi0t1Ztvvunn2QWOH1pn6bvPv3E6nTp06JAkef7xcjgccjgcstvtmjlzpubOnauYmBhFR0dr3rx5Sk9P14QJE/w2r0Bzvuvc1NSkrKwsHT16VOvWrVNjY6MaGxslSRdddJGCgoL8M7EAdL5rfXI7VVJSklJSUnw3kQB3vutss9n0yCOPaOHChbryyit11VVXac2aNdq7dy+fF/c957vOPn8t7PJzTrBmzJhhDRw40Orbt6910UUXWZmZmdbmzZs9+9va2qyFCxdaDofDCg0NtX784x9bu3bt8jrGJ598Yk2ZMsUaMGCAFR4ebg0fPvy0Ww9Nd7Z1XrVqlSXptG3hwoWePm6323rggQes6OhoKywszMrOzracTqcfZhO4zned33nnnXb3S7Kqq6v9M6kA1RU/06cSt92fpqvWuaCgwLrkkkus8PBwa8yYMdb27dt9PJPA1hXr7MvXQptlWVbXxywAAICeg2uIAACA8QhEAADAeAQiAABgPAIRAAAwHoEIAAAYj0AEAACMRyACAADGIxABAADjEYgAAIDxCEQAAMB4BCIA6IRjx475uwQAXYhABCDgbNq0Sddee60uvPBCxcTEKDs7W5999pkkaf/+/bLZbHrttdd03XXXKSwsTKNGjdInn3yi8vJyjRw5UhdccIFuvPFGffXVV+f0fOXl5Zo4caJiY2Nlt9s1btw4ffjhh159bDabXnjhBd12222KiIjQk08+KUn6y1/+ooyMDPXr10+DBg3SokWLdPz4cc+4wsJCpaenKyIiQomJiZo1a5aam5u7aKUAdBW+3BVAwPnzn/8sm82m9PR0HTlyRE888YT279+vyspKOZ1OpaSkaMiQISoqKlJSUpJmzJih1tZWRUVF6cknn1R4eLimTp2qCRMmaPny5Wd9vrfffluHDh1SRkaGJOm5557Tm2++qf/93/9VZGSkpO8C0YABA1RQUKDx48crKChIe/fu1dSpU/W73/1O1113nT777DPde++9uvvuu7Vw4UJJUlFRka688kolJyerurpas2bN0g033KDnn3+++xYQQMdZABDg6urqLEnWrl27rOrqakuS9dJLL3n2/+lPf7IkWVu3bvW0FRQUWIMHD+7U8x0/ftyKjIy0/vKXv3jaJFm5uble/a677jorPz/fq23t2rVWfHz8GY/92muvWTExMZ2qC0D34S0zAAHns88+07Rp0zRo0CBFRUUpJSVFkuR0Oj19hg8f7vlzXFycJCk9Pd2rra6u7pyer66uTvfdd58uv/xy2e122e12NTc3ez2fJI0cOdLrcUVFhRYvXqwLLrjAs91zzz2qqanR0aNHJUnvvPOOJk6cqIsvvliRkZH6xS9+oa+//lpHjhzpwIoA6G7B/i4AAE516623KjExUS+++KISEhLU1tamtLQ0tba2evqEhIR4/myz2dpta2trO6fnu/vuu/XVV1+pqKhIAwcOVGhoqMaMGeP1fJIUERHh9bitrU2LFi3SlClTTjtmv3799MUXX+jmm2/Wfffdp9/85jeKjo5WWVmZZs6cyUXZQIAhEAEIKF9//bX27NmjP/zhD7ruuuskSWVlZd36nNu3b9fzzz+vm2++WZJ04MABuVyus467+uqrtW/fPl122WXt7t+5c6eOHz+u5557Tn36fHdC/rXXXuu6wgF0GQIRgIDSv39/xcTEaMWKFYqPj5fT6dRjjz3Wrc952WWXae3atRo5cqQaGxv1yCOPKCws7KzjnnjiCWVnZysxMVG33367+vTpo48//li7du3Sk08+qUsvvVTHjx9XcXGxbr31Vv3973/XCy+80K1zAdA5XEMEIKD06dNHJSUlqqioUFpamh566CH99re/7dbnXLlyperr6zVixAhNnz5dc+bM0YABA846btKkSXrzzTdVWlqqUaNG6Uc/+pEKCws1cOBASdJVV12lwsJCPfPMM0pLS9Mf//hHFRQUdOtcAHQOt90DAADjcYYIAAAYj0AEoNf7/m3xp27bt2/3d3kAAgBvmQHo9T799NMz7rv44ovP6QJqAL0bgQgAABiPt8wAAIDxCEQAAMB4BCIAAGA8AhEAADAegQgAABiPQAQAAIxHIAIAAMb7Pwt4r9FArXElAAAAAElFTkSuQmCC\n",
      "text/plain": [
       "<Figure size 640x480 with 1 Axes>"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "sns.histplot(sc.read(os.path.join(os.path.join(source_path, samples[0], \"analysis\"), files['sm_matrix'])).obs['am_area'])"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "d8ebf5bc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2023-01-15T13:07:28.476029Z",
     "iopub.status.busy": "2023-01-15T13:07:28.475504Z",
     "iopub.status.idle": "2023-01-15T13:07:28.487283Z",
     "shell.execute_reply": "2023-01-15T13:07:28.485475Z"
    },
    "papermill": {
     "duration": 0.131974,
     "end_time": "2023-01-15T13:07:28.521169",
     "exception": false,
     "start_time": "2023-01-15T13:07:28.389195",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def assign_average_tpo(am_adata, overlap_data, min_overlap, method=np.mean):\n",
    "    if min_overlap is None:\n",
    "        min_overlap = 0\n",
    "    \n",
    "    overlap = overlap_data.overlap_regions\n",
    "    overlap['am_id'] = overlap['am_id'].astype(str)\n",
    "    overlap['cell_id'] = overlap['cell_id'].astype(str)\n",
    "    merged_df = pd.merge(overlap[['am_id', 'cell_id']], am_adata.obs[const.TPO], left_on='am_id', right_index=True)\n",
    "    merged_df = merged_df[merged_df[const.TPO] >= min_overlap]\n",
    "    \n",
    "    mean_df = merged_df[['cell_id', 'correction_total_pixel_overlap']].groupby('cell_id', group_keys=False).agg(method)\n",
    "#     mean_df = merged_df[['cell_id', 'correction_total_pixel_overlap']].groupby('cell_id', group_keys=False).agg(lambda x: method(x))\n",
    "    return mean_df[const.TPO]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "4e8bd986",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2023-01-15T13:07:28.703068Z",
     "iopub.status.busy": "2023-01-15T13:07:28.702503Z",
     "iopub.status.idle": "2023-01-15T13:07:40.149502Z",
     "shell.execute_reply": "2023-01-15T13:07:40.133804Z"
    },
    "papermill": {
     "duration": 11.564839,
     "end_time": "2023-01-15T13:07:40.155010",
     "exception": false,
     "start_time": "2023-01-15T13:07:28.590171",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def correct_sample_spacem(sample):\n",
    "    \n",
    "    sample_path = os.path.join(source_path, sample, \"analysis\")\n",
    "    sample = re.sub('/', '_', sample)\n",
    "    \n",
    "    if not os.path.exists(os.path.join(target_path, sample)):\n",
    "        os.makedirs(os.path.join(target_path, sample))\n",
    "\n",
    "    # get appropriate file paths for the processed well\n",
    "    project_files = {k: os.path.join(sample_path, v) for k, v in files.items()}\n",
    "\n",
    "    if os.path.exists(project_files['config']):\n",
    "        with open(project_files['config']) as json_file:\n",
    "            data = json.load(json_file)\n",
    "        deconv_info = data['single_cell_analysis']\n",
    "        if deconv_info['ablation_marks_min_overlap_ratio'] is None:\n",
    "            deconv_info['ablation_marks_min_overlap_ratio'] = deconv_default_min_overlap\n",
    "    else:\n",
    "        deconv_info = None\n",
    "        print('No well config file found. Using default deconvolution parameters.')\n",
    "    # load required files\n",
    "    cell_regions = pd.read_csv(project_files['cell_regions'])\n",
    "    mark_regions = pd.read_csv(project_files['mark_regions'])\n",
    "    overlap_regions = pd.read_csv(project_files['overlap_regions'])\n",
    "    \n",
    "    sm_matrix = sc.read(os.path.join(sample_path, files['sm_matrix']))\n",
    "    cell_sm_matrix = sc.read(os.path.join(sample_path, files['cell_sm_matrix']))\n",
    "       \n",
    "    add_overlap_matrix_spacem(sm_matrix, cell_regions, mark_regions, overlap_regions)\n",
    "    \n",
    "    add_normalization_factors(adata=sm_matrix, method=st.median)\n",
    "\n",
    "    # perform the actual quantile regression\n",
    "    corr_sm_matrix = correct_quantile_inplace(adata=sm_matrix, \n",
    "        reference_ions = get_reference_pool(sm_matrix), \n",
    "        correct_intersect = True,\n",
    "        proportion_threshold = correction_proportion_threshold,\n",
    "        n_jobs=5)\n",
    "    \n",
    "    # perform pixel-cell-deconvolution\n",
    "    overlap_data = get_overlap_data(cell_regions, mark_regions, overlap_regions)\n",
    "    corr_cell_sm_matrix = deconvolution_spacem(adata=corr_sm_matrix, \n",
    "        overlap_data=overlap_data,\n",
    "        raw_adata=cell_sm_matrix,\n",
    "        deconvolution_params=deconv_info)\n",
    "    gen_cell_sm_matrix = deconvolution_spacem(adata=sm_matrix,\n",
    "        overlap_data=overlap_data,\n",
    "        raw_adata=cell_sm_matrix,\n",
    "        deconvolution_params=deconv_info)\n",
    "    \n",
    "    # hand over TPOs to spatiomolecular matrix for downstream analysis\n",
    "    min_overlap = deconv_info['ablation_marks_min_overlap_ratio']\n",
    "    corr_cell_sm_matrix.obs['list_TPO'] = assign_average_tpo(sm_matrix, overlap_data, min_overlap, method=lambda x: \";\".join(x.astype(str)))\n",
    "    gen_cell_sm_matrix.obs['list_TPO'] = assign_average_tpo(sm_matrix, overlap_data, min_overlap, method=lambda x: \";\".join(x.astype(str)))\n",
    "    \n",
    "    # write the generated files to the dedicated project location.\n",
    "    # corr_sm_matrix.write(os.path.join(target_path, sample, 'am_spatiomolecular_adata_corrected.h5ad'))\n",
    "    # sm_matrix.write(os.path.join(target_path, sample, 'am_spatiomolecular_adata.h5ad'))\n",
    "    corr_cell_sm_matrix.write(os.path.join(target_path, sample, 'cells_spatiomolecular_adata_corrected.h5ad'))\n",
    "    cell_sm_matrix.write(os.path.join(target_path, sample, 'cells_spatiomolecular_adata_spacem.h5ad'))\n",
    "    gen_cell_sm_matrix.write(os.path.join(target_path, sample, 'cells_spatiomolecular_adata.h5ad'))\n",
    "    \n",
    "    return (sample, cell_sm_matrix, corr_cell_sm_matrix, sm_matrix, corr_sm_matrix, deconv_info)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "46c4b970",
   "metadata": {
    "papermill": {
     "duration": 0.048279,
     "end_time": "2023-01-15T13:07:40.219414",
     "exception": false,
     "start_time": "2023-01-15T13:07:40.171135",
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "This is the actual correction pipeline."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "7150fbf0",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2023-01-15T13:07:40.442880Z",
     "iopub.status.busy": "2023-01-15T13:07:40.442373Z"
    },
    "papermill": {
     "duration": 246.497417,
     "end_time": "2023-01-15T13:11:46.842896",
     "exception": false,
     "start_time": "2023-01-15T13:07:40.345479",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stderr",
     "output_type": "stream",
     "text": [
      " 37%|█████████████████████████████████████████████████████████████████████████▋                                                                                                                              | 7/19 [00:01<00:02,  5.01it/s]/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "/home/mklein/miniconda3/envs/ion_suppression/lib/python3.10/site-packages/statsmodels/regression/quantile_regression.py:191: IterationLimitWarning: Maximum number of iterations (1000) reached.\n",
      "  warnings.warn(\"Maximum number of iterations (\" + str(max_iter) +\n",
      "100%|███████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 19/19 [03:52<00:00, 12.25s/it]\n"
     ]
    }
   ],
   "source": [
    "adata_list = Parallel(n_jobs=7)(delayed(correct_sample_spacem)(sample) for sample in tqdm(samples))\n",
    "# adata_list = [correct_sample_spacem(sample) for sample in tqdm(['I4'])]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "dc4be0bb",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2023-01-12T15:37:48.476961Z",
     "iopub.status.busy": "2023-01-12T15:37:48.476093Z",
     "iopub.status.idle": "2023-01-12T15:37:49.983947Z",
     "shell.execute_reply": "2023-01-12T15:37:49.982737Z"
    },
    "papermill": {
     "duration": null,
     "end_time": null,
     "exception": null,
     "start_time": null,
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# reshape data for immediate analysis\n",
    "am_adata_dict = {item[0]: item[3] for item in adata_list}\n",
    "am_adata_cor_dict = {item[0]: item[4] for item in adata_list}\n",
    "adata_dict = {item[0]: item[1] for item in adata_list}\n",
    "adata_cor_dict = {item[0]: item[2] for item in adata_list}\n",
    "\n",
    "am_adata = ad.concat(am_adata_dict, label='well', index_unique=\"_\", merge=\"first\")\n",
    "am_adata_cor = ad.concat(am_adata_cor_dict, label='well', index_unique=\"_\", merge='first')\n",
    "adata = ad.concat(adata_dict, label='well', index_unique=\"_\", merge=\"first\")\n",
    "adata_cor = ad.concat(adata_cor_dict, label='well', index_unique=\"_\", merge=\"first\")\n",
    "\n",
    "deconv_dict = {item[0]: item[5] for item in adata_list}\n",
    "deconv_table = pd.DataFrame(deconv_dict).T\n",
    "deconv_table"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "047d123e-1b44-425f-b938-ee16217785f4",
   "metadata": {
    "papermill": {
     "duration": null,
     "end_time": null,
     "exception": null,
     "start_time": null,
     "status": "completed"
    },
    "tags": []
   },
   "source": [
    "The ion suppression correction takes a parameter proportion_threshold to filter the pixels used to compute quantile regression. In particular, pixels with a sampling proportion lower than the threshold are excluded for this step. In contrast, the actual correction is then performed on all pixels in the dataset. As a consequence, for the majority of the dataset, the dependence of the data on the factor \"sampling_proportion\" is not completely removed by the correction. Instead, depending on the difference in slope between the complete and thresholded set of pixels, the corrected set of pixels has a positive or negative dependence on the factor \"sampling_proportion\". The larger the proportion_threshold, the stronger this deviation can get.\n",
    "\n",
    "In the following figure, these differences are visualized for a subset of ions (with very low/high correction slope) and wells. The top panel shows the logarithmic ion intensity/proportion ratio plotted against the log proportion ratio of the respective pixels. As this is the relationship used to compute the quantile regression, the resulting regression lines can also be shown. The black lines show the quantile regression of the total set of pixels in a well, the red lines for the thresholded set (shown as orange squares). In turn, the blue squares are disregarded in calculating the correction slope. The bottom panel shows the corresponding corrected sets of pixels with black lines again representing the quantile regression on the complete set of pixels."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a8bc9f87",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2023-01-12T15:37:50.026101Z",
     "iopub.status.busy": "2023-01-12T15:37:50.025470Z",
     "iopub.status.idle": "2023-01-12T15:37:50.030889Z",
     "shell.execute_reply": "2023-01-12T15:37:50.029798Z"
    },
    "papermill": {
     "duration": null,
     "end_time": null,
     "exception": null,
     "start_time": null,
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import warnings\n",
    "warnings.filterwarnings('ignore')"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b4db43d3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2023-01-12T15:37:50.053228Z",
     "iopub.status.busy": "2023-01-12T15:37:50.052617Z",
     "iopub.status.idle": "2023-01-12T15:37:50.067449Z",
     "shell.execute_reply": "2023-01-12T15:37:50.066447Z"
    },
    "papermill": {
     "duration": null,
     "end_time": null,
     "exception": null,
     "start_time": null,
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "am_adata.obs[const.TPO] = am_adata_cor.obs[const.TPO]"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d8d86109",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2023-01-12T15:37:50.090985Z",
     "iopub.status.busy": "2023-01-12T15:37:50.089320Z",
     "iopub.status.idle": "2023-01-12T15:38:02.520951Z",
     "shell.execute_reply": "2023-01-12T15:38:02.519801Z"
    },
    "papermill": {
     "duration": null,
     "end_time": null,
     "exception": null,
     "start_time": null,
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "from src.evaluation import compare_pre_post_correction\n",
    "compare_pre_post_correction(am_adata, am_adata_cor, proportion_threshold=correction_proportion_threshold, wells = ['B1', 'E3', 'H3'])"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "“ion_suppression_new”",
   "language": "python",
   "name": "ion_suppression"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.10.8"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 373.895243,
   "end_time": "2023-01-15T13:11:46.889736",
   "environment_variables": {},
   "exception": null,
   "input_path": "analysis/Mx_Seahorse/pipeline_01_correction.ipynb",
   "output_path": "analysis/Mx_Seahorse/pipeline_01_correction.ipynb",
   "parameters": {
    "analysis_path": "/home/mklein/FDA_project/analysis/Mx_Seahorse",
    "condition_name": "treatment",
    "notebooks": [
     "pipeline_01_correction.ipynb",
     "pipeline_02_processing.ipynb",
     "pipeline_03_evaluation.ipynb"
    ],
    "project": "Mx_Seahorse",
    "source_path": "/home/mklein/Raw Data/220412_Luisa_ScSeahorse_SpaceM",
    "target_path": "/home/mklein/FDA_project/data/Mx_Seahorse",
    "well_name": "rowcol"
   },
   "start_time": "2023-01-15T13:05:32.994493",
   "version": "2.3.4"
  },
  "vscode": {
   "interpreter": {
    "hash": "89b4449ee30f46b148fb6825d70934bcbb1ebdb6d5b2015fe3835362773c7289"
   }
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
